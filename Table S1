Table S1
> ###输血与预后分析
> #7-8g输血与预后关系
> # install.packages("MatchIt")
> # install.packages("tableone")
> ##多因素分析
> options(scipen=999)
> 
> datavlow <- data[(data$low_hb>=7)&(data$low_hb<=8),]
> modelvlow <- glm(death28~truRed24+age2+BMI2+
+                    ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                    ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu, data=datavlow, family='binomial')
> summary(modelvlow)

Call:
glm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    family = "binomial", data = datavlow)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.3041  -0.4970  -0.2930  -0.1704   3.0634  

Coefficients: (1 not defined because of singularities)
                  Estimate Std. Error z value       Pr(>|z|)    
(Intercept)      1.0341014  5.9482424   0.174       0.861983    
truRed24                NA         NA      NA             NA    
age2>=65         0.4680533  0.2218688   2.110       0.034893 *  
BMI218.5-25     -0.0066790  0.4999448  -0.013       0.989341    
BMI2>25         -0.6220606  0.4853375  -1.282       0.199945    
ph2<=7.30        0.2448178  0.2302454   1.063       0.287650    
genderM          0.1491782  0.1989943   0.750       0.453459    
Renal           -0.0572919  0.2451049  -0.234       0.815183    
CHFYES           0.0084688  0.2282656   0.037       0.970405    
COPDYES          0.2281661  0.2326164   0.981       0.326658    
LiverYES         0.5989821  0.2440556   2.454       0.014116 *  
DiabetesYES     -0.3972622  0.2240234  -1.773       0.076178 .  
HR2>=100         0.8096471  0.2294516   3.529       0.000418 ***
MBP2<=65        -0.3252392  0.3216388  -1.011       0.311924    
RR2              0.5510748  0.2141537   2.573       0.010074 *  
pt               0.0189558  0.0089793   2.111       0.034768 *  
ptt              0.0030337  0.0034265   0.885       0.375956    
lac>=4           0.2545446  0.2346746   1.085       0.278068    
ventil           0.7795000  0.2514260   3.100       0.001933 ** 
SAPSIII>=60      1.5785568  0.2465334   6.403 0.000000000152 ***
sepsis_shockYES  1.0500318  0.2416976   4.344 0.000013965525 ***
sofa2>=5        -0.1641904  0.2167783  -0.757       0.448803    
po2             -0.0098753  0.0030561  -3.231       0.001232 ** 
pco2            -0.0076680  0.0084927  -0.903       0.366585    
glucose          0.0003125  0.0024700   0.127       0.899306    
potassium       -0.1349309  0.1628271  -0.829       0.407288    
T_min           -0.0590642  0.1205675  -0.490       0.624215    
T_max           -0.0340148  0.1289328  -0.264       0.791920    
los_icu         -0.0018920  0.0007126  -2.655       0.007932 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1007.75  on 1071  degrees of freedom
Residual deviance:  701.53  on 1044  degrees of freedom
AIC: 757.53

Number of Fisher Scoring iterations: 6

> exp(coef(modelvlow))
    (Intercept)        truRed24        age2>=65     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
      2.8125778              NA       1.5968825       0.9933432       0.5368371       1.2773886       1.1608798 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
      0.9443183       1.0085047       1.2562940       1.8202650       0.6721578       2.2471149       0.7223546 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
      1.7351169       1.0191366       1.0030383       1.2898741       2.1803817       4.8479544       2.8577420 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
      0.8485805       0.9901733       0.9923613       1.0003126       0.8737763       0.9426462       0.9665572 
        los_icu 
      0.9981098 
> exp(confint(modelvlow))
Waiting for profiling to be done...
                        2.5 %         97.5 %
(Intercept)     0.00002483048 345986.7381834
truRed24                   NA             NA
age2>=65        1.03883340045      2.4822064
BMI218.5-25     0.37774477297      2.7061268
BMI2>25         0.21001448755      1.4215255
ph2<=7.30       0.81205209768      2.0054031
genderM         0.78563885881      1.7159116
Renal           0.58134515754      1.5218847
CHFYES          0.64219090820      1.5736511
COPDYES         0.79269807868      1.9766109
LiverYES        1.12435842758      2.9308286
DiabetesYES     0.43092672585      1.0385436
HR2>=100        1.43138013425      3.5230358
MBP2<=65        0.37905713686      1.3406342
RR2             1.13983664219      2.6419392
pt              1.00120076428      1.0372530
ptt             0.99616579657      1.0096688
lac>=4          0.80991619401      2.0347710
ventil          1.34348809196      3.6069686
SAPSIII>=60     3.01418703121      7.9394620
sepsis_shockYES 1.78086111211      4.5993950
sofa2>=5        0.55206264334      1.2929027
po2             0.98400932589      0.9958621
pco2            0.97575008688      1.0088494
glucose         0.99539857436      1.0051137
potassium       0.63440503453      1.2020989
T_min           0.74758742581      1.2002943
T_max           0.74829845293      1.2413980
los_icu         0.99664349034      0.9994362
> exp(cbind(OR = coef(modelvlow), confint(modelvlow)))
Waiting for profiling to be done...
                       OR         2.5 %         97.5 %
(Intercept)     2.8125778 0.00002483048 345986.7381834
truRed24               NA            NA             NA
age2>=65        1.5968825 1.03883340045      2.4822064
BMI218.5-25     0.9933432 0.37774477297      2.7061268
BMI2>25         0.5368371 0.21001448755      1.4215255
ph2<=7.30       1.2773886 0.81205209768      2.0054031
genderM         1.1608798 0.78563885881      1.7159116
Renal           0.9443183 0.58134515754      1.5218847
CHFYES          1.0085047 0.64219090820      1.5736511
COPDYES         1.2562940 0.79269807868      1.9766109
LiverYES        1.8202650 1.12435842758      2.9308286
DiabetesYES     0.6721578 0.43092672585      1.0385436
HR2>=100        2.2471149 1.43138013425      3.5230358
MBP2<=65        0.7223546 0.37905713686      1.3406342
RR2             1.7351169 1.13983664219      2.6419392
pt              1.0191366 1.00120076428      1.0372530
ptt             1.0030383 0.99616579657      1.0096688
lac>=4          1.2898741 0.80991619401      2.0347710
ventil          2.1803817 1.34348809196      3.6069686
SAPSIII>=60     4.8479544 3.01418703121      7.9394620
sepsis_shockYES 2.8577420 1.78086111211      4.5993950
sofa2>=5        0.8485805 0.55206264334      1.2929027
po2             0.9901733 0.98400932589      0.9958621
pco2            0.9923613 0.97575008688      1.0088494
glucose         1.0003126 0.99539857436      1.0051137
potassium       0.8737763 0.63440503453      1.2020989
T_min           0.9426462 0.74758742581      1.2002943
T_max           0.9665572 0.74829845293      1.2413980
los_icu         0.9981098 0.99664349034      0.9994362

################### 倾向性匹配分析
> # install.packages("Matching")
> library(MatchIt)
> library(tableone)
> mvlow <-matchit(data=datavlow,
+                formula=truRed24~age2+BMI2+
+                  ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                  ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,
+                method="nearest",distance = "logit",replace=FALSE,caliper=0.1,ratio = 1)
> summary(mvlow)

Call:
matchit(formula = truRed24 ~ age2 + BMI2 + ph2 + gender + Renal + 
    CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + pt + ptt + 
    lac + ventil + SAPSIII + sepsis_shock + sofa2 + po2 + pco2 + 
    glucose + potassium + T_min + T_max + los_icu, data = datavlow, 
    method = "nearest", distance = "logit", replace = FALSE, 
    caliper = 0.1, ratio = 1)

Summary of Balance for All Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance               0.5031        0.4232          0.5925     0.9893    0.1623   0.2526
age2<80                0.6282        0.6630         -0.0721          .    0.0348   0.0348
age2>=80               0.3718        0.3370          0.0721          .    0.0348   0.0348
BMI2<18.5              0.0201        0.0265         -0.0454          .    0.0064   0.0064
BMI218.5-25            0.3040        0.2730          0.0674          .    0.0310   0.0310
BMI2>25                0.6758        0.7005         -0.0527          .    0.0246   0.0246
ph2>7.30               0.5421        0.5788         -0.0736          .    0.0367   0.0367
ph2<=7.30              0.4579        0.4212          0.0736          .    0.0367   0.0367
genderF                0.4560        0.5616         -0.2120          .    0.1056   0.1056
genderM                0.5440        0.4384          0.2120          .    0.1056   0.1056
Renal                  0.2821        0.3058         -0.0527          .    0.0237   0.0237
CHFNO                  0.6410        0.6022          0.0810          .    0.0388   0.0388
CHFYES                 0.3590        0.3978         -0.0810          .    0.0388   0.0388
COPDNO                 0.7161        0.7067          0.0209          .    0.0094   0.0094
COPDYES                0.2839        0.2933         -0.0209          .    0.0094   0.0094
LiverNO                0.8956        0.8970         -0.0047          .    0.0014   0.0014
LiverYES               0.1044        0.1030          0.0047          .    0.0014   0.0014
DiabetesNO             0.6722        0.5975          0.1590          .    0.0747   0.0747
DiabetesYES            0.3278        0.4025         -0.1590          .    0.0747   0.0747
HR2<100                0.8810        0.8705          0.0322          .    0.0104   0.0104
HR2>=100               0.1190        0.1295         -0.0322          .    0.0104   0.0104
MBP2>65                0.8773        0.8783         -0.0031          .    0.0010   0.0010
MBP2<=65               0.1227        0.1217          0.0031          .    0.0010   0.0010
RR2                    0.2161        0.2980         -0.1989          .    0.0819   0.0819
pt                    18.8289       18.4716          0.0395     0.9112    0.0267   0.0888
ptt                   50.4978       47.3585          0.1014     1.0557    0.0447   0.1154
lac<4                  0.7161        0.8159         -0.2213          .    0.0998   0.0998
lac>=4                 0.2839        0.1841          0.2213          .    0.0998   0.0998
ventil                 0.7802        0.6427          0.3320          .    0.1375   0.1375
SAPSIII<60             0.5879        0.6022         -0.0290          .    0.0143   0.0143
SAPSIII>=60            0.4121        0.3978          0.0290          .    0.0143   0.0143
sepsis_shockNO         0.7802        0.8097         -0.0711          .    0.0295   0.0295
sepsis_shockYES        0.2198        0.1903          0.0711          .    0.0295   0.0295
sofa2<5                0.6667        0.7051         -0.0816          .    0.0385   0.0385
sofa2>=5               0.3333        0.2949          0.0816          .    0.0385   0.0385
po2                  102.2582       99.9173          0.0545     0.8338    0.0209   0.0664
pco2                  46.2381       46.3370         -0.0102     0.7185    0.0220   0.0688
glucose              117.3553      114.2949          0.0905     0.8633    0.0230   0.0869
potassium              3.9916        4.0112         -0.0367     0.8336    0.0123   0.0421
T_min                 35.8054       36.0203         -0.2430     1.0085    0.0511   0.1448
T_max                 37.4428       37.3800          0.0861     1.0623    0.0194   0.0897
los_icu              125.9212      114.2949          0.0768     1.2943    0.0271   0.1069


Summary of Balance for Matched Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.
distance               0.4761        0.4706          0.0408     1.0676    0.0110   0.0549          0.0422
age2<80                0.6484        0.6440          0.0091          .    0.0044   0.0044          0.8822
age2>=80               0.3516        0.3560         -0.0091          .    0.0044   0.0044          0.8822
BMI2<18.5              0.0220        0.0242         -0.0156          .    0.0022   0.0022          0.2972
BMI218.5-25            0.2945        0.2857          0.0191          .    0.0088   0.0088          0.8505
BMI2>25                0.6835        0.6901         -0.0141          .    0.0066   0.0066          0.8593
ph2>7.30               0.5451        0.5736         -0.0573          .    0.0286   0.0286          0.9749
ph2<=7.30              0.4549        0.4264          0.0573          .    0.0286   0.0286          0.9749
genderF                0.4901        0.4901          0.0000          .    0.0000   0.0000          0.4396
genderM                0.5099        0.5099          0.0000          .    0.0000   0.0000          0.4396
Renal                  0.2791        0.3143         -0.0781          .    0.0352   0.0352          0.8889
CHFNO                  0.6330        0.6242          0.0183          .    0.0088   0.0088          0.9988
CHFYES                 0.3670        0.3758         -0.0183          .    0.0088   0.0088          0.9988
COPDNO                 0.7099        0.6967          0.0292          .    0.0132   0.0132          0.9359
COPDYES                0.2901        0.3033         -0.0292          .    0.0132   0.0132          0.9359
LiverNO                0.8967        0.9033         -0.0216          .    0.0066   0.0066          0.5678
LiverYES               0.1033        0.0967          0.0216          .    0.0066   0.0066          0.5678
DiabetesNO             0.6418        0.6330          0.0187          .    0.0088   0.0088          0.9270
DiabetesYES            0.3582        0.3670         -0.0187          .    0.0088   0.0088          0.9270
HR2<100                0.8813        0.8857         -0.0136          .    0.0044   0.0044          0.6108
HR2>=100               0.1187        0.1143          0.0136          .    0.0044   0.0044          0.6108
MBP2>65                0.8835        0.8813          0.0067          .    0.0022   0.0022          0.5694
MBP2<=65               0.1165        0.1187         -0.0067          .    0.0022   0.0022          0.5694
RR2                    0.2374        0.2220          0.0374          .    0.0154   0.0154          0.8063
pt                    18.5547       18.1189          0.0482     1.0288    0.0201   0.0659          0.7237
ptt                   49.9407       48.7376          0.0389     0.9295    0.0274   0.0747          0.8633
lac<4                  0.7560        0.7890         -0.0731          .    0.0330   0.0330          0.6970
lac>=4                 0.2440        0.2110          0.0731          .    0.0330   0.0330          0.6970
ventil                 0.7429        0.7473         -0.0106          .    0.0044   0.0044          0.7112
SAPSIII<60             0.5912        0.6176         -0.0536          .    0.0264   0.0264          0.9109
SAPSIII>=60            0.4088        0.3824          0.0536          .    0.0264   0.0264          0.9109
sepsis_shockNO         0.7868        0.8000         -0.0318          .    0.0132   0.0132          0.7643
sepsis_shockYES        0.2132        0.2000          0.0318          .    0.0132   0.0132          0.7643
sofa2<5                0.6901        0.6747          0.0326          .    0.0154   0.0154          0.8812
sofa2>=5               0.3099        0.3253         -0.0326          .    0.0154   0.0154          0.8812
po2                  101.7011      102.0352         -0.0078     0.8064    0.0147   0.0462          1.0282
pco2                  45.7670       46.1495         -0.0394     0.7343    0.0186   0.0484          1.1079
glucose              115.9978      116.0132         -0.0005     0.8061    0.0159   0.0637          1.1251
potassium              3.9982        4.0033         -0.0094     0.7793    0.0138   0.0396          1.1859
T_min                 35.8855       35.9068         -0.0241     0.7570    0.0141   0.0505          0.9903
T_max                 37.4142       37.4046          0.0131     0.9163    0.0115   0.0593          1.0244
los_icu              123.1033      114.5736          0.0563     1.1291    0.0290   0.1055          0.7436

Percent Balance Improvement:
                Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance                   93.1     -506.8      93.2     78.3
age2<80                    87.4          .      87.4     87.4
age2>=80                   87.4          .      87.4     87.4
BMI2<18.5                  65.5          .      65.5     65.5
BMI218.5-25                71.7          .      71.7     71.7
BMI2>25                    73.2          .      73.2     73.2
ph2>7.30                   22.1          .      22.1     22.1
ph2<=7.30                  22.1          .      22.1     22.1
genderF                   100.0          .     100.0    100.0
genderM                   100.0          .     100.0    100.0
Renal                     -48.2          .     -48.2    -48.2
CHFNO                      77.4          .      77.4     77.4
CHFYES                     77.4          .      77.4     77.4
COPDNO                    -40.2          .     -40.2    -40.2
COPDYES                   -40.2          .     -40.2    -40.2
LiverNO                  -360.6          .    -360.6   -360.6
LiverYES                 -360.6          .    -360.6   -360.6
DiabetesNO                 88.2          .      88.2     88.2
DiabetesYES                88.2          .      88.2     88.2
HR2<100                    57.9          .      57.9     57.9
HR2>=100                   57.9          .      57.9     57.9
MBP2>65                  -114.3          .    -114.3   -114.3
MBP2<=65                 -114.3          .    -114.3   -114.3
RR2                        81.2          .      81.2     81.2
pt                        -22.0       69.5      24.5     25.8
ptt                        61.7      -34.9      38.8     35.2
lac<4                      67.0          .      67.0     67.0
lac>=4                     67.0          .      67.0     67.0
ventil                     96.8          .      96.8     96.8
SAPSIII<60                -84.8          .     -84.8    -84.8
SAPSIII>=60               -84.8          .     -84.8    -84.8
sepsis_shockNO             55.2          .      55.2     55.2
sepsis_shockYES            55.2          .      55.2     55.2
sofa2<5                    60.0          .      60.0     60.0
sofa2>=5                   60.0          .      60.0     60.0
po2                        85.7      -18.4      29.7     30.5
pco2                     -286.8        6.6      15.3     29.7
glucose                    99.5      -46.7      30.8     26.7
potassium                  74.3      -37.0     -12.2      6.0
T_min                      90.1    -3201.3      72.5     65.1
T_max                      84.8      -44.5      40.9     33.8
los_icu                    26.6       52.9      -7.1      1.3

Sample Sizes:
          Control Treated
All           641     546
Matched       455     455
Unmatched     186      91
Discarded       0       0
######################提取匹配后病例对照
> set.seed(1111)
> mvlowdata <- match.data(mvlow,group = "all",
+                         distance = "distance",
+                         weights = "weights",
+                         subclass= "subclass",
+                         data = NULL,
+                         include.s.weights = TRUE,
+                         drop.unmatched = TRUE)
> modelmvlow <- glm(death28~truRed24, data=mvlowdata, family='binomial')
> summary(modelmvlow)

Call:
glm(formula = death28 ~ truRed24, family = "binomial", data = mvlowdata)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.6262  -0.6262  -0.4825  -0.4825   2.1016  

Coefficients:
            Estimate Std. Error z value            Pr(>|z|)    
(Intercept)  -1.5298     0.1226 -12.483 <0.0000000000000002 ***
truRed24YES  -0.5621     0.1936  -2.903              0.0037 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 749.99  on 909  degrees of freedom
Residual deviance: 741.35  on 908  degrees of freedom
AIC: 745.35

Number of Fisher Scoring iterations: 4

> exp(coef(modelmvlow))
(Intercept) truRed24YES 
  0.2165775   0.5700351 
> exp(confint(modelmvlow))
Waiting for profiling to be done...
                2.5 %    97.5 %
(Intercept) 0.1692217 0.2737651
truRed24YES 0.3880646 0.8302119
> exp(cbind(OR = coef(modelmvlow), confint(modelmvlow)))
Waiting for profiling to be done...
                   OR     2.5 %    97.5 %
(Intercept) 0.2165775 0.1692217 0.2737651
truRed24YES 0.5700351 0.3880646 0.8302119

 #逆概率加权分析
> #建立模型计算PS
> psModel=glm(truRed24~age2+BMI2+
+               ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+               ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,family = quasibinomial(link = "logit"),data = datavlow)
> datavlow$ps = predict(psModel,type = "response") #预测每位患者倾向性
> #逆概率加权
> datavlow$wt1 = 1/datavlow$ps  #输血组权重
> datavlow$wt2 = 1/(1-datavlow$ps) #未输血组权重
> #输血组权重为wt1未输血组权重为wt2
> datavlow$w <- ifelse(datavlow$truRed24=="YES",datavlow$wt1,datavlow$wt2)
> 
> #ITPW后的数据做table
> # install.packages("survey")
> library(survey)
载入需要的程辑包：grid
载入需要的程辑包：Matrix

载入程辑包：‘survey’

The following object is masked from ‘package:rms’:

    calibrate

The following object is masked from ‘package:Hmisc’:

    deff

The following object is masked from ‘package:graphics’:

    dotchart

> library(tableone)
> dataIPTW=svydesign(ids=~0,data=datavlow,weights=~w) #提取ITPW后数据
> #2再次构建Table-1模型
> vars=c("age2" ,"BMI2" ,"ph2" ,"gender", "Renal" ,"CHF", "COPD" ,"Liver" ,"Diabetes", 
+ "HR", "MBP2","RR2","pt","ptt","lac"," ventil", "SAPSIII",
+ "sepsis_shock","sofa2","po2","pco2", "glucose","potassium","T_min","T_max","los_icu")
> 
> tab_IPTW=svyCreateTableOne(vars=vars,strata="truRed24",data=dataIPTW,test=T)
Warning message:
In ModuleReturnVarsExist(vars, data$variables) :
  The data frame does not have:  ventil  Dropped
> print(tab_IPTW,showAllLevels=TRUE,smd=TRUE)
                       Stratified by truRed24
                        level   NO               YES              p      test SMD   
  n                              1192.7           1181.1                            
  age2 (%)              <80       779.0 (65.3)     762.9 (64.6)    0.804       0.015
                        >=80      413.7 (34.7)     418.2 (35.4)                     
  BMI2 (%)              <18.5      27.5 ( 2.3)      26.2 ( 2.2)    0.980       0.012
                        18.5-25   343.6 (28.8)     346.3 (29.3)                     
                        >25       821.6 (68.9)     808.6 (68.5)                     
  ph2 (%)               >7.30     676.5 (56.7)     681.6 (57.7)    0.745       0.020
                        <=7.30    516.2 (43.3)     499.6 (42.3)                     
  gender (%)            F         614.7 (51.5)     603.8 (51.1)    0.891       0.008
                        M         578.0 (48.5)     577.3 (48.9)                     
  Renal (mean (SD))                0.30 (0.46)      0.30 (0.46)    0.892       0.008
  CHF (%)               NO        743.1 (62.3)     737.5 (62.4)    0.962       0.003
                        YES       449.6 (37.7)     443.6 (37.6)                     
  COPD (%)              NO        843.8 (70.8)     833.0 (70.5)    0.936       0.005
                        YES       348.8 (29.2)     348.1 (29.5)                     
  Liver (%)             NO       1066.3 (89.4)    1054.6 (89.3)    0.951       0.004
                        YES       126.4 (10.6)     126.5 (10.7)                     
  Diabetes (%)          NO        747.2 (62.6)     745.1 (63.1)    0.884       0.009
                        YES       445.5 (37.4)     436.0 (36.9)                     
  HR (mean (SD))                  83.83 (14.25)    84.66 (13.08)   0.337       0.060
  MBP2 (%)              >65      1044.9 (87.6)    1031.6 (87.3)    0.895       0.008
                        <=65      147.8 (12.4)     149.5 (12.7)                     
  RR2 (mean (SD))                  0.26 (0.44)      0.26 (0.44)    0.917       0.007
  pt (mean (SD))                  18.53 (9.23)     18.45 (8.50)    0.882       0.009
  ptt (mean (SD))                 48.42 (30.80)    48.66 (29.76)   0.896       0.008
  lac (%)               <4        917.7 (76.9)     912.4 (77.2)    0.907       0.007
                        >=4       275.0 (23.1)     268.7 (22.8)                     
  SAPSIII (%)           <60       710.9 (59.6)     708.5 (60.0)    0.899       0.008
                        >=60      481.8 (40.4)     472.6 (40.0)                     
  sepsis_shock (%)      NO        946.8 (79.4)     937.7 (79.4)    0.998      <0.001
                        YES       245.9 (20.6)     243.4 (20.6)                     
  sofa2 (%)             <5        816.7 (68.5)     806.4 (68.3)    0.944       0.004
                        >=5       376.0 (31.5)     374.7 (31.7)                     
  po2 (mean (SD))                101.45 (48.45)   101.71 (43.93)   0.927       0.006
  pco2 (mean (SD))                45.88 (10.97)    45.70 (9.82)    0.778       0.017
  glucose (mean (SD))            116.51 (39.66)   115.60 (34.38)   0.718       0.024
  potassium (mean (SD))            4.00 (0.58)      3.99 (0.53)    0.858       0.011
  T_min (mean (SD))               35.87 (1.07)     35.90 (0.84)    0.665       0.031
  T_max (mean (SD))               37.41 (0.73)     37.41 (0.72)    0.945       0.004
  los_icu (mean (SD))            120.23 (140.06)  119.10 (142.65)  0.896       0.008
> addmargins(table(ExtractSmd(tab_IPTW)>0.1))

FALSE   Sum 
   25    25 
> #拟合逆概率加权后输血和28天死亡风险
> modelIPTW <-glm(death28~truRed24,family = quasibinomial(link = "logit"),data = datavlow,weight=w)
> summary(modelIPTW)

Call:
glm(formula = death28 ~ truRed24, family = quasibinomial(link = "logit"), 
    data = datavlow, weights = w)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.4729  -0.8276  -0.7399  -0.6271   5.3980  

Coefficients:
            Estimate Std. Error t value             Pr(>|t|)    
(Intercept)  -1.5265     0.1070  -14.26 < 0.0000000000000002 ***
truRed24YES  -0.5708     0.1699   -3.36             0.000805 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 2.003435)

    Null deviance: 1957.6  on 1186  degrees of freedom
Residual deviance: 1934.4  on 1185  degrees of freedom
AIC: NA

Number of Fisher Scoring iterations: 4

> exp(coef(modelIPTW))
(Intercept) truRed24YES 
  0.2172957   0.5650499 
> exp(confint(modelIPTW))
Waiting for profiling to be done...
                2.5 %    97.5 %
(Intercept) 0.1753077 0.2668059
truRed24YES 0.4034173 0.7860773
> exp(cbind(OR = coef(modelIPTW), confint(modelIPTW)))
Waiting for profiling to be done...
                   OR     2.5 %    97.5 %
(Intercept) 0.2172957 0.1753077 0.2668059
truRed24YES 0.5650499 0.4034173 0.7860773
> #双重稳健模型与28天死亡风险
> #拟合逆概率加权后输血和28天死亡风险
> ipw_svydesign <- svydesign(ids = ~ subject_id, weights = ~ w, data = datavlow)
> modelDB <-svyglm(death28~truRed24+age2+BMI2+
+                    ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                    ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,family = quasibinomial,design=ipw_svydesign)
> summary(modelDB)

Call:
svyglm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    design = ipw_svydesign, family = quasibinomial)

Survey design:
svydesign(ids = ~subject_id, weights = ~w, data = datavlow)

Coefficients:
                  Estimate Std. Error t value            Pr(>|t|)    
(Intercept)      9.7726452  7.4557625   1.311            0.190202    
truRed24YES     -0.7666242  0.2240530  -3.422            0.000644 ***
age2>=80         0.3778458  0.2297498   1.645            0.100324    
BMI218.5-25     -0.8230240  0.6691343  -1.230            0.218953    
BMI2>25         -1.2716584  0.6619770  -1.921            0.054977 .  
ph2<=7.30        0.3523990  0.2617749   1.346            0.178504    
genderM         -0.0167360  0.2199702  -0.076            0.939366    
Renal           -0.1777646  0.2483935  -0.716            0.474347    
CHFYES           0.0095701  0.2194259   0.044            0.965219    
COPDYES          0.1736644  0.2485471   0.699            0.484868    
LiverYES         0.6111197  0.3042002   2.009            0.044775 *  
DiabetesYES      0.0512633  0.2488098   0.206            0.836800    
HR2>=100         0.7287702  0.2811303   2.592            0.009654 ** 
MBP2<=65        -0.1561267  0.3736723  -0.418            0.676158    
RR2              0.5229337  0.2397977   2.181            0.029404 *  
pt               0.0296990  0.0108748   2.731            0.006410 ** 
ptt              0.0032179  0.0034413   0.935            0.349935    
lac>=4          -0.0197531  0.2648071  -0.075            0.940550    
ventil           0.7244454  0.3009501   2.407            0.016231 *  
SAPSIII>=60      2.0280962  0.2496249   8.125 0.00000000000000114 ***
sepsis_shockYES  1.3980893  0.3110790   4.494 0.00000767904191258 ***
sofa2>=5        -0.3909253  0.2432598  -1.607            0.108321    
po2             -0.0052783  0.0027840  -1.896            0.058216 .  
pco2            -0.0197073  0.0108681  -1.813            0.070042 .  
glucose          0.0008452  0.0037597   0.225            0.822173    
potassium       -0.4466752  0.1870390  -2.388            0.017093 *  
T_min           -0.0839746  0.1615771  -0.520            0.603359    
T_max           -0.1959401  0.1451782  -1.350            0.177391    
los_icu         -0.0015638  0.0007436  -2.103            0.035668 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 0.9481793)

Number of Fisher Scoring iterations: 6

> exp(coef(modelDB))
    (Intercept)     truRed24YES        age2>=80     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
  17547.1222273       0.4645787       1.4591380       0.4391018       0.2803663       1.4224760       0.9834033 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
      0.8371394       1.0096160       1.1896563       1.8424933       1.0526000       2.0725303       0.8554508 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
      1.6869694       1.0301444       1.0032231       0.9804407       2.0635864       7.5996047       4.0474593 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
      0.6764307       0.9947356       0.9804857       1.0008456       0.6397517       0.9194547       0.8220615 
        los_icu 
      0.9984374 
> exp(confint(modelDB))
                      2.5 %              97.5 %
(Intercept)     0.007784114 39555113625.7063141
truRed24YES     0.299326767           0.7210628
age2>=80        0.929669024           2.2901522
BMI218.5-25     0.118141144           1.6320343
BMI2>25         0.076499815           1.0275220
ph2<=7.30       0.851115784           2.3773945
genderM         0.638699753           1.5141419
Renal           0.514213698           1.3628622
CHFYES          0.656425018           1.5528423
COPDYES         0.730527381           1.9373430
LiverYES        1.014376798           3.3466673
DiabetesYES     0.646032725           1.7150321
HR2>=100        1.193856169           3.5979056
MBP2<=65        0.410952664           1.7807307
RR2             1.053846818           2.7004548
pt              1.008397560           1.0523603
ptt             0.996472336           1.0100196
lac>=4          0.583151385           1.6483952
ventil          1.143366352           3.7244307
SAPSIII>=60     4.656800341          12.4020758
sepsis_shockYES 2.198439496           7.4516158
sofa2>=5        0.419704400           1.0901921
po2             0.989316935           1.0001840
pco2            0.959799780           1.0016174
glucose         0.993489824           1.0082557
potassium       0.443237986           0.9233916
T_min           0.669655916           1.2624347
T_max           0.618299810           1.0929732
los_icu         0.996981850           0.9998951
> exp(cbind(OR = coef(modelDB), confint(modelDB)))
                           OR       2.5 %              97.5 %
(Intercept)     17547.1222273 0.007784114 39555113625.7063141
truRed24YES         0.4645787 0.299326767           0.7210628
age2>=80            1.4591380 0.929669024           2.2901522
BMI218.5-25         0.4391018 0.118141144           1.6320343
BMI2>25             0.2803663 0.076499815           1.0275220
ph2<=7.30           1.4224760 0.851115784           2.3773945
genderM             0.9834033 0.638699753           1.5141419
Renal               0.8371394 0.514213698           1.3628622
CHFYES              1.0096160 0.656425018           1.5528423
COPDYES             1.1896563 0.730527381           1.9373430
LiverYES            1.8424933 1.014376798           3.3466673
DiabetesYES         1.0526000 0.646032725           1.7150321
HR2>=100            2.0725303 1.193856169           3.5979056
MBP2<=65            0.8554508 0.410952664           1.7807307
RR2                 1.6869694 1.053846818           2.7004548
pt                  1.0301444 1.008397560           1.0523603
ptt                 1.0032231 0.996472336           1.0100196
lac>=4              0.9804407 0.583151385           1.6483952
ventil              2.0635864 1.143366352           3.7244307
SAPSIII>=60         7.5996047 4.656800341          12.4020758
sepsis_shockYES     4.0474593 2.198439496           7.4516158
sofa2>=5            0.6764307 0.419704400           1.0901921
po2                 0.9947356 0.989316935           1.0001840
pco2                0.9804857 0.959799780           1.0016174
glucose             1.0008456 0.993489824           1.0082557
potassium           0.6397517 0.443237986           0.9233916
T_min               0.9194547 0.669655916           1.2624347
T_max               0.8220615 0.618299810           1.0929732
los_icu             0.9984374 0.996981850           0.9998951

 ###输血与预后分析
> #8-9g输血与预后关系
> # install.packages("MatchIt")
> # install.packages("tableone")
> ##多因素分析
> datalow89 <- data[(data$low_hb>=8)&(data$low_hb<=9),]
> modellow89 <- glm(death28~truRed24+age2+BMI2+
+                    ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                    ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu, data=datalow89, family='binomial')
> summary(modellow89)

Call:
glm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    family = "binomial", data = datalow89)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.0260  -0.5003  -0.2958  -0.1797   2.7379  

Coefficients:
                  Estimate Std. Error z value             Pr(>|z|)    
(Intercept)     -2.2852469  4.0184304  -0.569             0.569566    
truRed24YES     -1.0828794  0.2200812  -4.920          0.000000864 ***
age2>=80         0.5318853  0.1672359   3.180             0.001470 ** 
BMI218.5-25     -0.6185364  0.3999489  -1.547             0.121975    
BMI2>25         -0.8595791  0.3888328  -2.211             0.027059 *  
ph2<=7.30       -0.1378305  0.1918839  -0.718             0.472571    
genderM          0.0400272  0.1636401   0.245             0.806762    
Renal            0.2094984  0.1789780   1.171             0.241789    
CHFYES          -0.1319566  0.1723147  -0.766             0.443802    
COPDYES          0.1812067  0.1773651   1.022             0.306942    
LiverYES         0.6227613  0.2431688   2.561             0.010436 *  
DiabetesYES     -0.2301253  0.1799649  -1.279             0.200995    
HR2>=100         0.3446975  0.2161379   1.595             0.110756    
MBP2<=65         0.4504528  0.2297914   1.960             0.049964 *  
RR2              0.6587329  0.1760541   3.742             0.000183 ***
pt               0.0142219  0.0069543   2.045             0.040851 *  
ptt              0.0048160  0.0025551   1.885             0.059446 .  
lac>=4           0.3936442  0.2064228   1.907             0.056523 .  
ventil           0.6679789  0.1990884   3.355             0.000793 ***
SAPSIII>=60      1.6870997  0.1917732   8.797 < 0.0000000000000002 ***
sepsis_shockYES  0.6950516  0.2085290   3.333             0.000859 ***
sofa2>=5        -0.1665204  0.1770389  -0.941             0.346917    
po2             -0.0058210  0.0021647  -2.689             0.007167 ** 
pco2             0.0043008  0.0067060   0.641             0.521306    
glucose          0.0018371  0.0019423   0.946             0.344243    
potassium        0.0309230  0.1475717   0.210             0.834022    
T_min            0.0715378  0.0899240   0.796             0.426302    
T_max           -0.0960380  0.0987662  -0.972             0.330863    
los_icu         -0.0010795  0.0005389  -2.003             0.045165 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1454.6  on 1650  degrees of freedom
Residual deviance: 1059.0  on 1622  degrees of freedom
AIC: 1117

Number of Fisher Scoring iterations: 6

> exp(coef(modellow89))
    (Intercept)     truRed24YES        age2>=80     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
      0.1017489       0.3386191       1.7021383       0.5387324       0.4233402       0.8712464       1.0408391 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
      1.2330594       0.8763790       1.1986630       1.8640682       0.7944340       1.4115629       1.5690225 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
      1.9323422       1.0143235       1.0048276       1.4823731       1.9502915       5.4037854       2.0038124 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
      0.8466055       0.9941960       1.0043100       1.0018387       1.0314061       1.0741587       0.9084295 
        los_icu 
      0.9989211 
> exp(confint(modellow89))
Waiting for profiling to be done...
                        2.5 %      97.5 %
(Intercept)     0.00003660334 263.0053323
truRed24YES     0.21735298740   0.5158469
age2>=80        1.22635145615   2.3638227
BMI218.5-25     0.24726246302   1.1926261
BMI2>25         0.19865986799   0.9175843
ph2<=7.30       0.59673280487   1.2669922
genderM         0.75542513014   1.4356855
Renal           0.86652019135   1.7488916
CHFYES          0.62367818964   1.2262839
COPDYES         0.84458840274   1.6940816
LiverYES        1.15111317960   2.9907375
DiabetesYES     0.55648665249   1.1276286
HR2>=100        0.91996678034   2.1485515
MBP2<=65        0.99596095425   2.4542644
RR2             1.36767378605   2.7287496
pt              1.00080269224   1.0285828
ptt             0.99971696189   1.0098001
lac>=4          0.98622208861   2.2172118
ventil          1.32662584182   2.8980375
SAPSIII>=60     3.73044188516   7.9197779
sepsis_shockYES 1.33032348607   3.0150996
sofa2>=5        0.59607499171   1.1939676
po2             0.98981750137   0.9982664
pco2            0.99110630121   1.0175591
glucose         0.99803524784   1.0056703
potassium       0.77191193669   1.3773042
T_min           0.90701484355   1.2894597
T_max           0.74748181278   1.1015244
los_icu         0.99782212632   0.9999410
> exp(cbind(OR = coef(modellow89), confint(modellow89)))
Waiting for profiling to be done...
                       OR         2.5 %      97.5 %
(Intercept)     0.1017489 0.00003660334 263.0053323
truRed24YES     0.3386191 0.21735298740   0.5158469
age2>=80        1.7021383 1.22635145615   2.3638227
BMI218.5-25     0.5387324 0.24726246302   1.1926261
BMI2>25         0.4233402 0.19865986799   0.9175843
ph2<=7.30       0.8712464 0.59673280487   1.2669922
genderM         1.0408391 0.75542513014   1.4356855
Renal           1.2330594 0.86652019135   1.7488916
CHFYES          0.8763790 0.62367818964   1.2262839
COPDYES         1.1986630 0.84458840274   1.6940816
LiverYES        1.8640682 1.15111317960   2.9907375
DiabetesYES     0.7944340 0.55648665249   1.1276286
HR2>=100        1.4115629 0.91996678034   2.1485515
MBP2<=65        1.5690225 0.99596095425   2.4542644
RR2             1.9323422 1.36767378605   2.7287496
pt              1.0143235 1.00080269224   1.0285828
ptt             1.0048276 0.99971696189   1.0098001
lac>=4          1.4823731 0.98622208861   2.2172118
ventil          1.9502915 1.32662584182   2.8980375
SAPSIII>=60     5.4037854 3.73044188516   7.9197779
sepsis_shockYES 2.0038124 1.33032348607   3.0150996
sofa2>=5        0.8466055 0.59607499171   1.1939676
po2             0.9941960 0.98981750137   0.9982664
pco2            1.0043100 0.99110630121   1.0175591
glucose         1.0018387 0.99803524784   1.0056703
potassium       1.0314061 0.77191193669   1.3773042
T_min           1.0741587 0.90701484355   1.2894597
T_max           0.9084295 0.74748181278   1.1015244
los_icu         0.9989211 0.99782212632   0.9999410

 # 倾向性匹配分析
> # install.packages("Matching")
> library(MatchIt)
> library(tableone)
> mlow89 <-matchit(data=datalow89,
+                 formula=truRed24~age2+BMI2+
+                   ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                   ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,
+                 method="nearest",distance = "logit",replace=FALSE,caliper=0.1,ratio = 1)
> summary(mlow89)

Call:
matchit(formula = truRed24 ~ age2 + BMI2 + ph2 + gender + Renal + 
    CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + pt + ptt + 
    lac + ventil + SAPSIII + sepsis_shock + sofa2 + po2 + pco2 + 
    glucose + potassium + T_min + T_max + los_icu, data = datalow89, 
    method = "nearest", distance = "logit", replace = FALSE, 
    caliper = 0.1, ratio = 1)

Summary of Balance for All Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance               0.3683        0.2425          0.7538     1.4460    0.2206   0.3461
age2<80                0.6223        0.6488         -0.0547          .    0.0265   0.0265
age2>=80               0.3777        0.3512          0.0547          .    0.0265   0.0265
BMI2<18.5              0.0109        0.0335         -0.2176          .    0.0226   0.0226
BMI218.5-25            0.2686        0.2833         -0.0333          .    0.0148   0.0148
BMI2>25                0.7205        0.6832          0.0833          .    0.0374   0.0374
ph2>7.30               0.4869        0.6295         -0.2853          .    0.1426   0.1426
ph2<=7.30              0.5131        0.3705          0.2853          .    0.1426   0.1426
genderF                0.4389        0.4778         -0.0784          .    0.0389   0.0389
genderM                0.5611        0.5222          0.0784          .    0.0389   0.0389
Renal                  0.2183        0.3118         -0.2263          .    0.0935   0.0935
CHFNO                  0.6769        0.6178          0.1263          .    0.0591   0.0591
CHFYES                 0.3231        0.3822         -0.1263          .    0.0591   0.0591
COPDNO                 0.7183        0.6991          0.0428          .    0.0193   0.0193
COPDYES                0.2817        0.3009         -0.0428          .    0.0193   0.0193
LiverNO                0.8908        0.9179         -0.0867          .    0.0270   0.0270
LiverYES               0.1092        0.0821          0.0867          .    0.0270   0.0270
DiabetesNO             0.6987        0.5985          0.2184          .    0.1002   0.1002
DiabetesYES            0.3013        0.4015         -0.2184          .    0.1002   0.1002
HR2<100                0.9039        0.8718          0.1092          .    0.0322   0.0322
HR2>=100               0.0961        0.1282         -0.1092          .    0.0322   0.0322
MBP2>65                0.8843        0.8676          0.0523          .    0.0167   0.0167
MBP2<=65               0.1157        0.1324         -0.0523          .    0.0167   0.0167
RR2                    0.2009        0.3386         -0.3439          .    0.1378   0.1378
pt                    18.0762       18.0261          0.0063     0.6530    0.0289   0.1291
ptt                   49.9452       45.2381          0.1553     1.0731    0.0689   0.1811
lac<4                  0.7162        0.8424         -0.2800          .    0.1263   0.1263
lac>=4                 0.2838        0.1576          0.2800          .    0.1263   0.1263
ventil                 0.8275        0.6203          0.5485          .    0.2072   0.2072
SAPSIII<60             0.6507        0.5943          0.1182          .    0.0564   0.0564
SAPSIII>=60            0.3493        0.4057         -0.1182          .    0.0564   0.0564
sepsis_shockNO         0.7817        0.8290         -0.1146          .    0.0473   0.0473
sepsis_shockYES        0.2183        0.1710          0.1146          .    0.0473   0.0473
sofa2<5                0.6965        0.7158         -0.0421          .    0.0193   0.0193
sofa2>=5               0.3035        0.2842          0.0421          .    0.0193   0.0193
po2                   98.2991       99.0738         -0.0211     0.6067    0.0296   0.1021
pco2                  48.2424       46.5968          0.1798     0.5117    0.0371   0.1410
glucose              120.2533      117.5071          0.0780     0.7930    0.0212   0.0893
potassium              4.0009        3.9982          0.0054     0.8442    0.0106   0.0367
T_min                 35.7516       36.0527         -0.2788     1.4536    0.0614   0.1771
T_max                 37.4404       37.3903          0.0678     0.8014    0.0175   0.0764
los_icu              131.7009      115.1391          0.1045     1.4411    0.0278   0.0897


Summary of Balance for Matched Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.
distance               0.3415        0.3389          0.0156     1.0438    0.0025   0.0337          0.0167
age2<80                0.6274        0.6250          0.0050          .    0.0024   0.0024          0.9272
age2>=80               0.3726        0.3750         -0.0050          .    0.0024   0.0024          0.9272
BMI2<18.5              0.0120        0.0120          0.0000          .    0.0000   0.0000          0.0192
BMI218.5-25            0.2716        0.2788         -0.0163          .    0.0072   0.0072          0.8841
BMI2>25                0.7163        0.7091          0.0161          .    0.0072   0.0072          0.9053
ph2>7.30               0.5288        0.5409         -0.0240          .    0.0120   0.0120          0.8320
ph2<=7.30              0.4712        0.4591          0.0240          .    0.0120   0.0120          0.8320
genderF                0.4519        0.4639         -0.0242          .    0.0120   0.0120          0.9252
genderM                0.5481        0.5361          0.0242          .    0.0120   0.0120          0.9252
Renal                  0.2260        0.1947          0.0756          .    0.0312   0.0312          0.7390
CHFNO                  0.6755        0.7067         -0.0668          .    0.0312   0.0312          0.8173
CHFYES                 0.3245        0.2933          0.0668          .    0.0312   0.0312          0.8173
COPDNO                 0.7139        0.7188         -0.0107          .    0.0048   0.0048          0.8658
COPDYES                0.2861        0.2812          0.0107          .    0.0048   0.0048          0.8658
LiverNO                0.8990        0.8966          0.0077          .    0.0024   0.0024          0.5935
LiverYES               0.1010        0.1034         -0.0077          .    0.0024   0.0024          0.5935
DiabetesNO             0.6803        0.6803          0.0000          .    0.0000   0.0000          0.4038
DiabetesYES            0.3197        0.3197          0.0000          .    0.0000   0.0000          0.4038
HR2<100                0.8990        0.8918          0.0245          .    0.0072   0.0072          0.6771
HR2>=100               0.1010        0.1082         -0.0245          .    0.0072   0.0072          0.6771
MBP2>65                0.8870        0.8702          0.0526          .    0.0168   0.0168          0.6538
MBP2<=65               0.1130        0.1298         -0.0526          .    0.0168   0.0168          0.6538
RR2                    0.2163        0.2212         -0.0120          .    0.0048   0.0048          0.7920
pt                    18.0375       17.4488          0.0736     1.2069    0.0161   0.0841          0.7095
ptt                   48.7666       48.4738          0.0097     0.7915    0.0450   0.1514          0.9205
lac<4                  0.7620        0.7500          0.0267          .    0.0120   0.0120          0.6665
lac>=4                 0.2380        0.2500         -0.0267          .    0.0120   0.0120          0.6665
ventil                 0.8125        0.7837          0.0764          .    0.0288   0.0288          0.5599
SAPSIII<60             0.6514        0.6346          0.0353          .    0.0168   0.0168          0.8723
SAPSIII>=60            0.3486        0.3654         -0.0353          .    0.0168   0.0168          0.8723
sepsis_shockNO         0.7957        0.8149         -0.0466          .    0.0192   0.0192          0.7448
sepsis_shockYES        0.2043        0.1851          0.0466          .    0.0192   0.0192          0.7448
sofa2<5                0.7212        0.7115          0.0209          .    0.0096   0.0096          0.8156
sofa2>=5               0.2788        0.2885         -0.0209          .    0.0096   0.0096          0.8156
po2                   99.5264       97.9062          0.0442     0.6828    0.0184   0.0913          1.1297
pco2                  47.8269       46.9784          0.0927     0.6348    0.0213   0.0986          1.1400
glucose              119.8798      120.6298         -0.0213     0.6665    0.0243   0.0769          1.1134
potassium              4.0082        3.9832          0.0510     0.8958    0.0099   0.0529          1.1310
T_min                 35.8538       35.8836         -0.0276     0.6762    0.0188   0.0889          0.8452
T_max                 37.4338       37.4738         -0.0542     0.6909    0.0164   0.0409          1.1187
los_icu              126.7043      128.0433         -0.0084     1.0790    0.0171   0.0721          0.7798

Percent Balance Improvement:
                Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance                   97.9       88.4      98.9     90.3
age2<80                    90.9          .      90.9     90.9
age2>=80                   90.9          .      90.9     90.9
BMI2<18.5                 100.0          .     100.0    100.0
BMI218.5-25                51.1          .      51.1     51.1
BMI2>25                    80.7          .      80.7     80.7
ph2>7.30                   91.6          .      91.6     91.6
ph2<=7.30                  91.6          .      91.6     91.6
genderF                    69.1          .      69.1     69.1
genderM                    69.1          .      69.1     69.1
Renal                      66.6          .      66.6     66.6
CHFNO                      47.1          .      47.1     47.1
CHFYES                     47.1          .      47.1     47.1
COPDNO                     75.0          .      75.0     75.0
COPDYES                    75.0          .      75.0     75.0
LiverNO                    91.1          .      91.1     91.1
LiverYES                   91.1          .      91.1     91.1
DiabetesNO                100.0          .     100.0    100.0
DiabetesYES               100.0          .     100.0    100.0
HR2<100                    77.6          .      77.6     77.6
HR2>=100                   77.6          .      77.6     77.6
MBP2>65                    -0.6          .      -0.6     -0.6
MBP2<=65                   -0.6          .      -0.6     -0.6
RR2                        96.5          .      96.5     96.5
pt                      -1074.3       55.9      44.2     34.8
ptt                        93.8     -231.5      34.7     16.4
lac<4                      90.5          .      90.5     90.5
lac>=4                     90.5          .      90.5     90.5
ventil                     86.1          .      86.1     86.1
SAPSIII<60                 70.1          .      70.1     70.1
SAPSIII>=60                70.1          .      70.1     70.1
sepsis_shockNO             59.4          .      59.4     59.4
sepsis_shockYES            59.4          .      59.4     59.4
sofa2<5                    50.3          .      50.3     50.3
sofa2>=5                   50.3          .      50.3     50.3
po2                      -109.2       23.6      37.9     10.5
pco2                       48.4       32.2      42.8     30.1
glucose                    72.7      -74.9     -14.2     13.8
potassium                -849.3       35.0       7.4    -44.0
T_min                      90.1       -4.6      69.4     49.8
T_max                      20.1      -67.0       6.3     46.5
los_icu                    91.9       79.2      38.6     19.6

Sample Sizes:
          Control Treated
All          1193     458
Matched       416     416
Unmatched     777      42
Discarded       0       0

 #提取匹配后病例对照
> set.seed(1111)
> mlowdata89 <- match.data(mlow89,group = "all",
+                         distance = "distance",
+                         weights = "weights",
+                         subclass= "subclass",
+                         data = NULL,
+                         include.s.weights = TRUE,
+                         drop.unmatched = TRUE)
> modelmlow89 <- glm(death28~truRed24, data=mlowdata89, family='binomial')
> summary(modelmlow89)

Call:
glm(formula = death28 ~ truRed24, family = "binomial", data = mlowdata89)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.6536  -0.6536  -0.4193  -0.4193   2.2250  

Coefficients:
            Estimate Std. Error z value             Pr(>|z|)    
(Intercept)  -1.4351     0.1244 -11.536 < 0.0000000000000002 ***
truRed24YES  -0.9524     0.2160  -4.408            0.0000104 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 668.46  on 831  degrees of freedom
Residual deviance: 647.55  on 830  degrees of freedom
AIC: 651.55

Number of Fisher Scoring iterations: 5

> exp(coef(modelmlow89))
(Intercept) truRed24YES 
  0.2380952   0.3858268 
> exp(confint(modelmlow89))
Waiting for profiling to be done...
                2.5 %    97.5 %
(Intercept) 0.1853767 0.3020896
truRed24YES 0.2500418 0.5845629
> exp(cbind(OR = coef(modelmlow89), confint(modelmlow89)))
Waiting for profiling to be done...
                   OR     2.5 %    97.5 %
(Intercept) 0.2380952 0.1853767 0.3020896
truRed24YES 0.3858268 0.2500418 0.5845629

> #逆概率加权分析
> #建立模型计算PS
> psModel89=glm(truRed24~age2+BMI2+
+               ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+               ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,family = quasibinomial(link = "logit"),data = datalow89)
> datalow89$ps = predict(psModel89,type = "response") #预测每位患者倾向性
> #逆概率加权
> datalow89$wt1 = 1/datalow89$ps  #输血组权重
> datalow89$wt2 = 1/(1-datalow89$ps) #未输血组权重
> #输血组权重为wt1未输血组权重为wt2
> datalow89$w <- ifelse(datalow89$truRed24=="YES",datalow89$wt1,datalow89$wt2)

#ITPW后的数据做table
> # install.packages("survey")
> library(survey)
> library(tableone)
> dataIPTW89=svydesign(ids=~0,data=datalow89,weights=~w) #提取ITPW后数据
> #2再次构建Table-1模型
> vars=c("age2" ,"BMI2" ,"ph2" ,"gender", "Renal" ,"CHF", "COPD" ,"Liver" ,"Diabetes", 
+        "HR", "MBP2","RR2","pt","ptt","lac"," ventil", "SAPSIII",
+        "sepsis_shock","sofa2","po2","pco2", "glucose","potassium","T_min","T_max","los_icu")
> 
> tab_IPTW89=svyCreateTableOne(vars=vars,strata="truRed24",data=dataIPTW89,test=T)
Warning message:
In ModuleReturnVarsExist(vars, data$variables) :
  The data frame does not have:  ventil  Dropped
> print(tab_IPTW89,showAllLevels=TRUE,smd=TRUE)
                       Stratified by truRed24
                        level   NO               YES              p      test SMD   
  n                              1652.3           1679.2                            
  age2 (%)              <80      1060.4 (64.2)    1073.6 (63.9)    0.939       0.005
                        >=80      591.9 (35.8)     605.6 (36.1)                     
  BMI2 (%)              <18.5      44.9 ( 2.7)      30.0 ( 1.8)    0.515       0.080
                        18.5-25   459.4 (27.8)     509.6 (30.4)                     
                        >25      1148.0 (69.5)    1139.6 (67.9)                     
  ph2 (%)               >7.30     977.6 (59.2)    1032.6 (61.5)    0.452       0.047
                        <=7.30    674.6 (40.8)     646.6 (38.5)                     
  gender (%)            F         777.5 (47.1)     822.5 (49.0)    0.565       0.038
                        M         874.8 (52.9)     856.8 (51.0)                     
  Renal (mean (SD))                0.28 (0.45)      0.28 (0.45)    0.858       0.013
  CHF (%)               NO       1047.5 (63.4)    1066.3 (63.5)    0.976       0.002
                        YES       604.8 (36.6)     613.0 (36.5)                     
  COPD (%)              NO       1161.7 (70.3)    1206.1 (71.8)    0.606       0.033
                        YES       490.6 (29.7)     473.1 (28.2)                     
  Liver (%)             NO       1502.1 (90.9)    1520.7 (90.6)    0.848       0.012
                        YES       150.2 ( 9.1)     158.5 ( 9.4)                     
  Diabetes (%)          NO       1034.7 (62.6)    1007.7 (60.0)    0.441       0.054
                        YES       617.6 (37.4)     671.5 (40.0)                     
  HR (mean (SD))                  83.34 (14.07)    84.79 (14.02)   0.157       0.103
  MBP2 (%)              >65      1442.4 (87.3)    1504.6 (89.6)    0.223       0.072
                        <=65      209.9 (12.7)     174.7 (10.4)                     
  RR2 (mean (SD))                  0.30 (0.46)      0.31 (0.46)    0.795       0.019
  pt (mean (SD))                  18.06 (9.72)     17.59 (7.53)    0.318       0.054
  ptt (mean (SD))                 46.56 (30.68)    46.23 (27.42)   0.851       0.011
  lac (%)               <4       1334.9 (80.8)    1370.1 (81.6)    0.724       0.021
                        >=4       317.4 (19.2)     309.1 (18.4)                     
  SAPSIII (%)           <60      1009.1 (61.1)    1029.0 (61.3)    0.951       0.004
                        >=60      643.2 (38.9)     650.2 (38.7)                     
  sepsis_shock (%)      NO       1345.5 (81.4)    1409.3 (83.9)    0.249       0.066
                        YES       306.7 (18.6)     269.9 (16.1)                     
  sofa2 (%)             <5       1174.1 (71.1)    1182.5 (70.4)    0.832       0.014
                        >=5       478.1 (28.9)     496.7 (29.6)                     
  po2 (mean (SD))                 98.91 (45.88)    99.18 (38.57)   0.920       0.006
  pco2 (mean (SD))                47.01 (12.54)    46.39 (9.45)    0.360       0.056
  glucose (mean (SD))            117.97 (39.60)   116.56 (32.57)   0.512       0.039
  potassium (mean (SD))            4.00 (0.53)      3.99 (0.52)    0.897       0.009
  T_min (mean (SD))               35.94 (1.10)     35.96 (0.85)    0.839       0.013
  T_max (mean (SD))               37.41 (0.86)     37.43 (0.73)    0.677       0.026
  los_icu (mean (SD))            119.24 (140.17)  118.41 (140.10)  0.917       0.006

> addmargins(table(ExtractSmd(tab_IPTW89)>0.1))

FALSE  TRUE   Sum 
   24     1    25 
   
  > #拟合逆概率加权后输血和28天死亡风险
> modelIPTW89 <-glm(death28~truRed24,family = quasibinomial(link = "logit"),data = datalow89,weight=w)
> summary(modelIPTW89)

Call:
glm(formula = death28 ~ truRed24, family = quasibinomial(link = "logit"), 
    data = datalow89, weights = w)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.2594  -0.7861  -0.7187  -0.6325   7.0910  

Coefficients:
            Estimate Std. Error t value             Pr(>|t|)    
(Intercept) -1.43212    0.08865 -16.155 < 0.0000000000000002 ***
truRed24YES -0.99035    0.15470  -6.402         0.0000000002 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 2.020595)

    Null deviance: 2657.7  on 1650  degrees of freedom
Residual deviance: 2568.2  on 1649  degrees of freedom
AIC: NA

Number of Fisher Scoring iterations: 4

> exp(coef(modelIPTW89))
(Intercept) truRed24YES 
  0.2388019   0.3714477 
> exp(confint(modelIPTW89))
Waiting for profiling to be done...
                2.5 %    97.5 %
(Intercept) 0.2000688 0.2832727
truRed24YES 0.2728524 0.5008461
> exp(cbind(OR = coef(modelIPTW89), confint(modelIPTW89)))
Waiting for profiling to be done...
                   OR     2.5 %    97.5 %
(Intercept) 0.2388019 0.2000688 0.2832727
truRed24YES 0.3714477 0.2728524 0.5008461
> #双重稳健模型与28天死亡风险
> #拟合逆概率加权后输血和28天死亡风险
> ipw_svydesign89 <- svydesign(ids = ~ subject_id, weights = ~ w, data = datalow89)
> modelDB89 <-svyglm(death28~truRed24+age2+BMI2+
+                    ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                    ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,family = quasibinomial,design=ipw_svydesign89)
> summary(modelDB89)

Call:
svyglm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    design = ipw_svydesign89, family = quasibinomial)

Survey design:
svydesign(ids = ~subject_id, weights = ~w, data = datalow89)

Coefficients:
                 Estimate Std. Error t value             Pr(>|t|)    
(Intercept)     -7.170989   6.142354  -1.167             0.243194    
truRed24YES     -1.143147   0.216573  -5.278          0.000000148 ***
age2>=80         0.754492   0.211086   3.574             0.000361 ***
BMI218.5-25     -1.085848   0.565195  -1.921             0.054883 .  
BMI2>25         -1.479251   0.544518  -2.717             0.006665 ** 
ph2<=7.30       -0.198038   0.227371  -0.871             0.383887    
genderM          0.157499   0.200524   0.785             0.432313    
Renal            0.051757   0.228843   0.226             0.821098    
CHFYES          -0.113549   0.205322  -0.553             0.580319    
COPDYES          0.192777   0.208682   0.924             0.355736    
LiverYES         1.123904   0.302006   3.721             0.000205 ***
DiabetesYES     -0.374152   0.236932  -1.579             0.114497    
HR2>=100         0.126301   0.292182   0.432             0.665604    
MBP2<=65         0.478973   0.291021   1.646             0.099990 .  
RR2              0.624889   0.208456   2.998             0.002762 ** 
pt               0.022122   0.008110   2.728             0.006449 ** 
ptt              0.006080   0.002940   2.068             0.038827 *  
lac>=4           0.579693   0.228681   2.535             0.011340 *  
ventil           0.726258   0.272414   2.666             0.007752 ** 
SAPSIII>=60      1.953581   0.222134   8.795 < 0.0000000000000002 ***
sepsis_shockYES  0.674312   0.269071   2.506             0.012305 *  
sofa2>=5        -0.292514   0.202715  -1.443             0.149218    
po2             -0.006093   0.002733  -2.229             0.025928 *  
pco2            -0.001365   0.007917  -0.172             0.863148    
glucose          0.003213   0.002364   1.359             0.174274    
potassium       -0.129031   0.209937  -0.615             0.538893    
T_min            0.058493   0.094944   0.616             0.537928    
T_max            0.071730   0.172454   0.416             0.677513    
los_icu         -0.001576   0.000563  -2.800             0.005178 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 0.7994139)

Number of Fisher Scoring iterations: 6

> exp(coef(modelDB89))
    (Intercept)     truRed24YES        age2>=80     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
   0.0007685619    0.3188140442    2.1265312324    0.3376154890    0.2278081821    0.8203388062    1.1705796421 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
   1.0531201433    0.8926602651    1.2126124053    3.0768415313    0.6878726682    1.1346236226    1.6144162658 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
   1.8680386398    1.0223687033    1.0060982997    1.7854897511    2.0673309993    7.0539040007    1.9626830812 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
   0.7463848479    0.9939250000    0.9986359922    1.0032180220    0.8789463816    1.0602372712    1.0743646903 
        los_icu 
   0.9984251475 
> exp(confint(modelDB89))
                            2.5 %      97.5 %
(Intercept)     0.000000004501873 131.2092748
truRed24YES     0.208474471097035   0.4875532
age2>=80        1.405596787031639   3.2172349
BMI218.5-25     0.111421215312599   1.0230028
BMI2>25         0.078294037948327   0.6628419
ph2<=7.30       0.525182963898406   1.2813739
genderM         0.789926552054120   1.7346634
Renal           0.672265911465247   1.6497371
CHFYES          0.596740234170451   1.3353253
COPDYES         0.805302352449359   1.8259339
LiverYES        1.701550852404727   5.5637208
DiabetesYES     0.432195677805987   1.0948023
HR2>=100        0.639676455532873   2.0125342
MBP2<=65        0.912249144876479   2.8570483
RR2             1.241125214130185   2.8116167
pt              1.006233299549737   1.0387628
ptt             1.000312508138916   1.0119176
lac>=4          1.140140965135942   2.7961224
ventil          1.211595837293644   3.5274613
SAPSIII>=60     4.562552059697826  10.9056425
sepsis_shockYES 1.157831683380774   3.3270163
sofa2>=5        0.501513833143244   1.1108175
po2             0.988610572376180   0.9992680
pco2            0.983247372144458   1.0142655
glucose         0.998577453897022   1.0078802
potassium       0.582277388284540   1.3267675
T_min           0.880089224612024   1.2772604
T_max           0.766035572423117   1.5067962
los_icu         0.997323251556940   0.9995283
> exp(cbind(OR = coef(modelDB89), confint(modelDB89)))
                          OR             2.5 %      97.5 %
(Intercept)     0.0007685619 0.000000004501873 131.2092748
truRed24YES     0.3188140442 0.208474471097035   0.4875532
age2>=80        2.1265312324 1.405596787031639   3.2172349
BMI218.5-25     0.3376154890 0.111421215312599   1.0230028
BMI2>25         0.2278081821 0.078294037948327   0.6628419
ph2<=7.30       0.8203388062 0.525182963898406   1.2813739
genderM         1.1705796421 0.789926552054120   1.7346634
Renal           1.0531201433 0.672265911465247   1.6497371
CHFYES          0.8926602651 0.596740234170451   1.3353253
COPDYES         1.2126124053 0.805302352449359   1.8259339
LiverYES        3.0768415313 1.701550852404727   5.5637208
DiabetesYES     0.6878726682 0.432195677805987   1.0948023
HR2>=100        1.1346236226 0.639676455532873   2.0125342
MBP2<=65        1.6144162658 0.912249144876479   2.8570483
RR2             1.8680386398 1.241125214130185   2.8116167
pt              1.0223687033 1.006233299549737   1.0387628
ptt             1.0060982997 1.000312508138916   1.0119176
lac>=4          1.7854897511 1.140140965135942   2.7961224
ventil          2.0673309993 1.211595837293644   3.5274613
SAPSIII>=60     7.0539040007 4.562552059697826  10.9056425
sepsis_shockYES 1.9626830812 1.157831683380774   3.3270163
sofa2>=5        0.7463848479 0.501513833143244   1.1108175
po2             0.9939250000 0.988610572376180   0.9992680
pco2            0.9986359922 0.983247372144458   1.0142655
glucose         1.0032180220 0.998577453897022   1.0078802
potassium       0.8789463816 0.582277388284540   1.3267675
T_min           1.0602372712 0.880089224612024   1.2772604
T_max           1.0743646903 0.766035572423117   1.5067962
los_icu         0.9984251475 0.997323251556940   0.9995283 
   
 ###输血与预后分析
> #9-10g输血与预后关系
> # install.packages("MatchIt")
> # install.packages("tableone")
> ##多因素分析
> datalow90 <- data[(data$low_hb>=9)&(data$low_hb<=10),]
> modellow90 <- glm(death28~truRed24+age2+BMI2+
+                     ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                     ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu, data=datalow90, family='binomial')
> summary(modellow90)

Call:
glm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    family = "binomial", data = datalow90)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.0065  -0.4692  -0.2822  -0.1752   2.8546  

Coefficients:
                  Estimate Std. Error z value         Pr(>|z|)    
(Intercept)      5.0738145  4.7245806   1.074         0.282859    
truRed24YES     -0.4244746  0.2685400  -1.581         0.113952    
age2>=80         0.4968274  0.1796434   2.766         0.005681 ** 
BMI218.5-25     -1.3821982  0.4226929  -3.270         0.001076 ** 
BMI2>25         -1.5327322  0.4098129  -3.740         0.000184 ***
ph2<=7.30       -0.5557000  0.2052617  -2.707         0.006784 ** 
genderM         -0.5543370  0.1781850  -3.111         0.001864 ** 
Renal            0.4449484  0.1908209   2.332         0.019713 *  
CHFYES           0.0759063  0.1808677   0.420         0.674720    
COPDYES          0.0458012  0.1864779   0.246         0.805983    
LiverYES         0.5993621  0.2722368   2.202         0.027692 *  
DiabetesYES     -0.4040521  0.1923325  -2.101         0.035659 *  
HR2>=100         0.4507113  0.2171941   2.075         0.037972 *  
MBP2<=65        -0.0479370  0.2756474  -0.174         0.861939    
RR2              0.6076421  0.1870808   3.248         0.001162 ** 
pt               0.0145691  0.0076874   1.895         0.058067 .  
ptt              0.0100937  0.0025585   3.945 0.00007974981100 ***
lac>=4           0.2577696  0.2112761   1.220         0.222442    
ventil           0.7591194  0.2204470   3.444         0.000574 ***
SAPSIII>=60      1.3895500  0.2012704   6.904 0.00000000000506 ***
sepsis_shockYES  1.0423014  0.2288413   4.555 0.00000524628028 ***
sofa2>=5         0.1785893  0.1871140   0.954         0.339860    
po2             -0.0074549  0.0025012  -2.981         0.002877 ** 
pco2             0.0111321  0.0063346   1.757         0.078857 .  
glucose          0.0034070  0.0021925   1.554         0.120205    
potassium        0.2439366  0.1468140   1.662         0.096606 .  
T_min           -0.1919795  0.1000764  -1.918         0.055069 .  
T_max           -0.0508178  0.1161612  -0.437         0.661766    
los_icu         -0.0023800  0.0006768  -3.517         0.000437 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1332.94  on 1603  degrees of freedom
Residual deviance:  959.49  on 1575  degrees of freedom
AIC: 1017.5

Number of Fisher Scoring iterations: 6

> exp(coef(modellow90))
    (Intercept)     truRed24YES        age2>=80     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
    159.7826548       0.6541134       1.6434988       0.2510261       0.2159449       0.5736706       0.5744530 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
      1.5604097       1.0788615       1.0468663       1.8209569       0.6676093       1.5694281       0.9531938 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
      1.8360969       1.0146757       1.0101448       1.2940406       2.1363940       4.0130439       2.8357357 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
      1.1955296       0.9925728       1.0111943       1.0034128       1.2762634       0.8253238       0.9504519 
        los_icu 
      0.9976229 
> exp(confint(modellow90))
Waiting for profiling to be done...
                     2.5 %          97.5 %
(Intercept)     0.01611351 1840417.5244277
truRed24YES     0.37981687       1.0911679
age2>=80        1.15550148       2.3385898
BMI218.5-25     0.11015407       0.5814644
BMI2>25         0.09737943       0.4888718
ph2<=7.30       0.38164153       0.8541369
genderM         0.40444584       0.8138824
Renal           1.07124451       2.2653600
CHFYES          0.75531775       1.5359633
COPDYES         0.72381153       1.5048206
LiverYES        1.05784600       3.0820702
DiabetesYES     0.45571275       0.9694508
HR2>=100        1.02127449       2.3951016
MBP2<=65        0.55064546       1.6250830
RR2             1.27278816       2.6520560
pt              0.99940907       1.0301344
ptt             1.00504200       1.0151924
lac>=4          0.85105162       1.9502510
ventil          1.39600061       3.3172471
SAPSIII>=60     2.71554442       5.9841815
sepsis_shockYES 1.81105872       4.4458775
sofa2>=5        0.82566304       1.7207549
po2             0.98750471       0.9972236
pco2            0.99854355       1.0237032
glucose         0.99908456       1.0077210
potassium       0.95819716       1.7045564
T_min           0.68071274       1.0080928
T_max           0.75487136       1.1911298
los_icu         0.99623345       0.9988870
> exp(cbind(OR = coef(modellow90), confint(modellow90)))
Waiting for profiling to be done...
                         OR      2.5 %          97.5 %
(Intercept)     159.7826548 0.01611351 1840417.5244277
truRed24YES       0.6541134 0.37981687       1.0911679
age2>=80          1.6434988 1.15550148       2.3385898
BMI218.5-25       0.2510261 0.11015407       0.5814644
BMI2>25           0.2159449 0.09737943       0.4888718
ph2<=7.30         0.5736706 0.38164153       0.8541369
genderM           0.5744530 0.40444584       0.8138824
Renal             1.5604097 1.07124451       2.2653600
CHFYES            1.0788615 0.75531775       1.5359633
COPDYES           1.0468663 0.72381153       1.5048206
LiverYES          1.8209569 1.05784600       3.0820702
DiabetesYES       0.6676093 0.45571275       0.9694508
HR2>=100          1.5694281 1.02127449       2.3951016
MBP2<=65          0.9531938 0.55064546       1.6250830
RR2               1.8360969 1.27278816       2.6520560
pt                1.0146757 0.99940907       1.0301344
ptt               1.0101448 1.00504200       1.0151924
lac>=4            1.2940406 0.85105162       1.9502510
ventil            2.1363940 1.39600061       3.3172471
SAPSIII>=60       4.0130439 2.71554442       5.9841815
sepsis_shockYES   2.8357357 1.81105872       4.4458775
sofa2>=5          1.1955296 0.82566304       1.7207549
po2               0.9925728 0.98750471       0.9972236
pco2              1.0111943 0.99854355       1.0237032
glucose           1.0034128 0.99908456       1.0077210
potassium         1.2762634 0.95819716       1.7045564
T_min             0.8253238 0.68071274       1.0080928
T_max             0.9504519 0.75487136       1.1911298
los_icu           0.9976229 0.99623345       0.9988870

 # 倾向性匹配分析
> # install.packages("Matching")
> library(MatchIt)
> library(tableone)
> mlow90 <-matchit(data=datalow90,
+                  formula=truRed24~age2+BMI2+
+                    ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                    ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,
+                  method="nearest",distance = "logit",replace=FALSE,caliper=0.1,ratio = 1)
> summary(mlow90)

Call:
matchit(formula = truRed24 ~ age2 + BMI2 + ph2 + gender + Renal + 
    CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + pt + ptt + 
    lac + ventil + SAPSIII + sepsis_shock + sofa2 + po2 + pco2 + 
    glucose + potassium + T_min + T_max + los_icu, data = datalow90, 
    method = "nearest", distance = "logit", replace = FALSE, 
    caliper = 0.1, ratio = 1)

Summary of Balance for All Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance               0.2331        0.1349          0.6967     2.1633    0.2191   0.3173
age2<80                0.6667        0.6422          0.0518          .    0.0244   0.0244
age2>=80               0.3333        0.3578         -0.0518          .    0.0244   0.0244
BMI2<18.5              0.0042        0.0293         -0.3906          .    0.0252   0.0252
BMI218.5-25            0.2083        0.2735         -0.1604          .    0.0651   0.0651
BMI2>25                0.7875        0.6972          0.2207          .    0.0903   0.0903
ph2>7.30               0.4458        0.6144         -0.3391          .    0.1685   0.1685
ph2<=7.30              0.5542        0.3856          0.3391          .    0.1685   0.1685
genderF                0.3250        0.4113         -0.1842          .    0.0863   0.0863
genderM                0.6750        0.5887          0.1842          .    0.0863   0.0863
Renal                  0.2042        0.2595         -0.1373          .    0.0554   0.0554
CHFNO                  0.6750        0.6459          0.0621          .    0.0291   0.0291
CHFYES                 0.3250        0.3541         -0.0621          .    0.0291   0.0291
COPDNO                 0.6875        0.7053         -0.0384          .    0.0178   0.0178
COPDYES                0.3125        0.2947          0.0384          .    0.0178   0.0178
LiverNO                0.8792        0.9326         -0.1638          .    0.0534   0.0534
LiverYES               0.1208        0.0674          0.1638          .    0.0534   0.0534
DiabetesNO             0.6417        0.6261          0.0325          .    0.0156   0.0156
DiabetesYES            0.3583        0.3739         -0.0325          .    0.0156   0.0156
HR2<100                0.8542        0.8629         -0.0248          .    0.0087   0.0087
HR2>=100               0.1458        0.1371          0.0248          .    0.0087   0.0087
MBP2>65                0.8917        0.9142         -0.0726          .    0.0226   0.0226
MBP2<=65               0.1083        0.0858          0.0726          .    0.0226   0.0226
RR2                    0.2167        0.3651         -0.3603          .    0.1484   0.1484
pt                    16.6663       17.3245         -0.1045     0.4478    0.0304   0.0940
ptt                   45.4608       43.4362          0.0705     1.0074    0.0363   0.1145
lac<4                  0.7000        0.8328         -0.2899          .    0.1328   0.1328
lac>=4                 0.3000        0.1672          0.2899          .    0.1328   0.1328
ventil                 0.7917        0.6459          0.3589          .    0.1458   0.1458
SAPSIII<60             0.6250        0.6268         -0.0038          .    0.0018   0.0018
SAPSIII>=60            0.3750        0.3732          0.0038          .    0.0018   0.0018
sepsis_shockNO         0.7417        0.8585         -0.2669          .    0.1168   0.1168
sepsis_shockYES        0.2583        0.1415          0.2669          .    0.1168   0.1168
sofa2<5                0.6792        0.7471         -0.1455          .    0.0679   0.0679
sofa2>=5               0.3208        0.2529          0.1455          .    0.0679   0.0679
po2                   96.9167       97.6437         -0.0173     0.7720    0.0190   0.0770
pco2                  49.4833       47.8629          0.1452     0.7002    0.0322   0.1220
glucose              121.2417      118.3849          0.0839     0.8664    0.0163   0.0770
potassium              4.0471        3.9672          0.1577     0.8108    0.0208   0.0833
T_min                 35.8547       36.1180         -0.2991     1.1700    0.0564   0.1633
T_max                 37.4596       37.4621         -0.0034     0.9637    0.0100   0.0503
los_icu              136.8167      108.1598          0.1671     1.7139    0.0478   0.1241


Summary of Balance for Matched Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.
distance               0.2154        0.2146          0.0054     1.0185    0.0010   0.0268          0.0083
age2<80                0.6741        0.6518          0.0474          .    0.0223   0.0223          0.9944
age2>=80               0.3259        0.3482         -0.0474          .    0.0223   0.0223          0.9944
BMI2<18.5              0.0045        0.0000          0.0693          .    0.0045   0.0045          0.0693
BMI218.5-25            0.2098        0.2277         -0.0440          .    0.0179   0.0179          0.9014
BMI2>25                0.7857        0.7723          0.0327          .    0.0134   0.0134          0.9058
ph2>7.30               0.4643        0.4821         -0.0359          .    0.0179   0.0179          0.8083
ph2<=7.30              0.5357        0.5179          0.0359          .    0.0179   0.0179          0.8083
genderF                0.3348        0.3616         -0.0572          .    0.0268   0.0268          0.8578
genderM                0.6652        0.6384          0.0572          .    0.0268   0.0268          0.8578
Renal                  0.2098        0.2188         -0.0222          .    0.0089   0.0089          0.8639
CHFNO                  0.6786        0.6786          0.0000          .    0.0000   0.0000          0.4107
CHFYES                 0.3214        0.3214          0.0000          .    0.0000   0.0000          0.4107
COPDNO                 0.6830        0.7143         -0.0674          .    0.0312   0.0312          0.9150
COPDYES                0.3170        0.2857          0.0674          .    0.0312   0.0312          0.9150
LiverNO                0.8839        0.8750          0.0274          .    0.0089   0.0089          0.5479
LiverYES               0.1161        0.1250         -0.0274          .    0.0089   0.0089          0.5479
DiabetesNO             0.6429        0.6518         -0.0186          .    0.0089   0.0089          0.8565
DiabetesYES            0.3571        0.3482          0.0186          .    0.0089   0.0089          0.8565
HR2<100                0.8482        0.8795         -0.0885          .    0.0312   0.0312          0.6704
HR2>=100               0.1518        0.1205          0.0885          .    0.0312   0.0312          0.6704
MBP2>65                0.8973        0.8973          0.0000          .    0.0000   0.0000          0.1964
MBP2<=65               0.1027        0.1027          0.0000          .    0.0000   0.0000          0.1964
RR2                    0.2277        0.1875          0.0975          .    0.0402   0.0402          0.7260
pt                    16.6330       17.4625         -0.1317     0.7933    0.0259   0.0670          0.8146
ptt                   44.1978       45.1424         -0.0329     0.8511    0.0224   0.0670          0.8563
lac<4                  0.7321        0.7277          0.0097          .    0.0045   0.0045          0.6917
lac>=4                 0.2679        0.2723         -0.0097          .    0.0045   0.0045          0.6917
ventil                 0.7768        0.7723          0.0110          .    0.0045   0.0045          0.6706
SAPSIII<60             0.6339        0.6205          0.0277          .    0.0134   0.0134          1.0051
SAPSIII>=60            0.3661        0.3795         -0.0277          .    0.0134   0.0134          1.0051
sepsis_shockNO         0.7679        0.7812         -0.0306          .    0.0134   0.0134          0.6425
sepsis_shockYES        0.2321        0.2188          0.0306          .    0.0134   0.0134          0.6425
sofa2<5                0.7009        0.6652          0.0765          .    0.0357   0.0357          0.8990
sofa2>=5               0.2991        0.3348         -0.0765          .    0.0357   0.0357          0.8990
po2                   96.5580       96.6518         -0.0022     0.9967    0.0151   0.0580          0.9900
pco2                  49.5134       48.2589          0.1124     1.0381    0.0181   0.1161          0.9452
glucose              120.6473      120.0580          0.0173     0.8021    0.0110   0.0580          1.0929
potassium              4.0424        4.0705         -0.0556     0.8011    0.0111   0.0670          1.1719
T_min                 35.8881       35.9028         -0.0167     0.8592    0.0137   0.0491          0.9144
T_max                 37.4595       37.4888         -0.0401     1.0900    0.0131   0.0625          1.1019
los_icu              126.7857      131.2009         -0.0257     0.6611    0.0275   0.1473          0.7235

Percent Balance Improvement:
                Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance                   99.2       97.6      99.5     91.6
age2<80                     8.7          .       8.7      8.7
age2>=80                    8.7          .       8.7      8.7
BMI2<18.5                  82.3          .      82.3     82.3
BMI218.5-25                72.6          .      72.6     72.6
BMI2>25                    85.2          .      85.2     85.2
ph2>7.30                   89.4          .      89.4     89.4
ph2<=7.30                  89.4          .      89.4     89.4
genderF                    69.0          .      69.0     69.0
genderM                    69.0          .      69.0     69.0
Renal                      83.9          .      83.9     83.9
CHFNO                     100.0          .     100.0    100.0
CHFYES                    100.0          .     100.0    100.0
COPDNO                    -75.8          .     -75.8    -75.8
COPDYES                   -75.8          .     -75.8    -75.8
LiverNO                    83.3          .      83.3     83.3
LiverYES                   83.3          .      83.3     83.3
DiabetesNO                 42.6          .      42.6     42.6
DiabetesYES                42.6          .      42.6     42.6
HR2<100                  -257.7          .    -257.7   -257.7
HR2>=100                 -257.7          .    -257.7   -257.7
MBP2>65                   100.0          .     100.0    100.0
MBP2<=65                  100.0          .     100.0    100.0
RR2                        72.9          .      72.9     72.9
pt                        -26.0       71.2      14.6     28.8
ptt                        53.3    -2073.5      38.2     41.5
lac<4                      96.6          .      96.6     96.6
lac>=4                     96.6          .      96.6     96.6
ventil                     96.9          .      96.9     96.9
SAPSIII<60               -630.7          .    -630.7   -630.7
SAPSIII>=60              -630.7          .    -630.7   -630.7
sepsis_shockNO             88.5          .      88.5     88.5
sepsis_shockYES            88.5          .      88.5     88.5
sofa2<5                    47.4          .      47.4     47.4
sofa2>=5                   47.4          .      47.4     47.4
po2                        87.1       98.7      20.6     24.6
pco2                       22.6       89.5      43.7      4.9
glucose                    79.4      -53.7      32.4     24.7
potassium                  64.8       -5.8      46.9     19.7
T_min                      94.4        3.4      75.7     69.9
T_max                   -1067.6     -133.3     -30.9    -24.2
los_icu                    84.6       23.2      42.5    -18.7

Sample Sizes:
          Control Treated
All          1364     240
Matched       224     224
Unmatched    1140      16
Discarded       0       0

> #提取匹配后病例对照
> set.seed(1111)
> mlowdata90 <- match.data(mlow90,group = "all",
+                          distance = "distance",
+                          weights = "weights",
+                          subclass= "subclass",
+                          data = NULL,
+                          include.s.weights = TRUE,
+                          drop.unmatched = TRUE)
> modelmlow90 <- glm(death28~truRed24, data=mlowdata90, family='binomial')
> summary(modelmlow90)

Call:
glm(formula = death28 ~ truRed24, family = "binomial", data = mlowdata90)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.6009  -0.6009  -0.4968  -0.4968   2.0754  

Coefficients:
            Estimate Std. Error z value            Pr(>|z|)    
(Intercept)  -1.6202     0.1799  -9.005 <0.0000000000000002 ***
truRed24YES  -0.4100     0.2755  -1.488               0.137    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 363.86  on 447  degrees of freedom
Residual deviance: 361.62  on 446  degrees of freedom
AIC: 365.62

Number of Fisher Scoring iterations: 4

> exp(coef(modelmlow90))
(Intercept) truRed24YES 
  0.1978610   0.6636637 
> exp(confint(modelmlow90))
Waiting for profiling to be done...
                2.5 %    97.5 %
(Intercept) 0.1369931 0.2779223
truRed24YES 0.3834720 1.1339530
> exp(cbind(OR = coef(modelmlow90), confint(modelmlow90)))
Waiting for profiling to be done...
                   OR     2.5 %    97.5 %
(Intercept) 0.1978610 0.1369931 0.2779223
truRed24YES 0.6636637 0.3834720 1.1339530

#建立模型计算PS
> psModel90=glm(truRed24~age2+BMI2+
+                 ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                 ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,family = quasibinomial(link = "logit"),data = datalow90)
> datalow90$ps = predict(psModel90,type = "response") #预测每位患者倾向性
> #逆概率加权
> datalow90$wt1 = 1/datalow90$ps  #输血组权重
> datalow90$wt2 = 1/(1-datalow90$ps) #未输血组权重
> #输血组权重为wt1未输血组权重为wt2
> datalow90$w <- ifelse(datalow90$truRed24=="YES",datalow90$wt1,datalow90$wt2)
> > #ITPW后的数据做table
> # install.packages("survey")
> library(survey)
> library(tableone)
> dataIPTW90=svydesign(ids=~subject_id,data=datalow90,weights=~w) #提取ITPW后数据
> #2再次构建Table-1模型
> vars=c("age2" ,"BMI2" ,"ph2" ,"gender", "Renal" ,"CHF", "COPD" ,"Liver" ,"Diabetes", 
+        "HR", "MBP2","RR2","pt","ptt","lac"," ventil", "SAPSIII",
+        "sepsis_shock","sofa2","po2","pco2", "glucose","potassium","T_min","T_max","los_icu")
> 
> tab_IPTW90=svyCreateTableOne(vars=vars,strata="truRed24",data=dataIPTW90,test=T)
Warning message:
In ModuleReturnVarsExist(vars, data$variables) :
  The data frame does not have:  ventil  Dropped
> print(tab_IPTW90,showAllLevels=TRUE,smd=TRUE)
                       Stratified by truRed24
                        level   NO               YES              p      test SMD   
  n                              1602.3           1654.0                            
  age2 (%)              <80      1036.4 (64.7)    1103.4 (66.7)    0.665       0.043
                        >=80      565.9 (35.3)     550.7 (33.3)                     
  BMI2 (%)              <18.5      40.9 ( 2.6)       7.4 ( 0.4)    0.150       0.190
                        18.5-25   424.7 (26.5)     505.2 (30.5)                     
                        >25      1136.7 (70.9)    1141.4 (69.0)                     
  ph2 (%)               >7.30     948.3 (59.2)    1050.1 (63.5)    0.296       0.088
                        <=7.30    654.0 (40.8)     603.9 (36.5)                     
  gender (%)            F         640.3 (40.0)     716.6 (43.3)    0.481       0.068
                        M         962.0 (60.0)     937.4 (56.7)                     
  Renal (mean (SD))                0.25 (0.43)      0.25 (0.44)    0.938       0.008
  CHF (%)               NO       1043.5 (65.1)    1065.5 (64.4)    0.883       0.015
                        YES       558.8 (34.9)     588.5 (35.6)                     
  COPD (%)              NO       1124.0 (70.1)    1239.1 (74.9)    0.203       0.107
                        YES       478.4 (29.9)     414.9 (25.1)                     
  Liver (%)             NO       1482.8 (92.5)    1514.1 (91.5)    0.690       0.037
                        YES       119.5 ( 7.5)     140.0 ( 8.5)                     
  Diabetes (%)          NO       1008.1 (62.9)    1093.6 (66.1)    0.461       0.067
                        YES       594.2 (37.1)     560.4 (33.9)                     
  HR (mean (SD))                  84.29 (13.99)    84.14 (13.02)   0.896       0.011
  MBP2 (%)              >65      1459.1 (91.1)    1508.1 (91.2)    0.959       0.004
                        <=65      143.2 ( 8.9)     145.9 ( 8.8)                     
  RR2 (mean (SD))                  0.34 (0.47)      0.37 (0.48)    0.541       0.065
  pt (mean (SD))                  17.24 (9.06)     17.27 (9.54)    0.976       0.003
  ptt (mean (SD))                 43.64 (28.71)    42.18 (26.00)   0.518       0.053
  lac (%)               <4       1306.1 (81.5)    1363.9 (82.5)    0.748       0.025
                        >=4       296.2 (18.5)     290.1 (17.5)                     
  SAPSIII (%)           <60      1006.5 (62.8)    1101.4 (66.6)    0.389       0.079
                        >=60      595.8 (37.2)     552.6 (33.4)                     
  sepsis_shock (%)      NO       1349.5 (84.2)    1391.6 (84.1)    0.975       0.002
                        YES       252.8 (15.8)     262.5 (15.9)                     
  sofa2 (%)             <5       1183.3 (73.8)    1229.6 (74.3)    0.897       0.011
                        >=5       419.0 (26.2)     424.4 (25.7)                     
  po2 (mean (SD))                 97.63 (46.97)   102.72 (61.71)   0.528       0.093
  pco2 (mean (SD))                48.06 (13.24)    46.81 (10.65)   0.206       0.104
  glucose (mean (SD))            118.72 (36.83)   117.80 (31.92)   0.740       0.027
  potassium (mean (SD))            3.98 (0.56)      3.97 (0.51)    0.841       0.019
  T_min (mean (SD))               36.07 (0.94)     36.08 (0.79)    0.876       0.013
  T_max (mean (SD))               37.46 (0.75)     37.49 (0.76)    0.752       0.032
  los_icu (mean (SD))            111.73 (141.60)  107.22 (122.31)  0.634       0.034
> addmargins(table(ExtractSmd(tab_IPTW90)>0.1))

FALSE  TRUE   Sum 
   22     3    25
   
   > #拟合逆概率加权后输血和28天死亡风险
> modelIPTW90 <-glm(death28~truRed24,family = quasibinomial(link = "logit"),data = datalow90,weight=w)
> summary(modelIPTW90)

Call:
glm(formula = death28 ~ truRed24, family = quasibinomial(link = "logit"), 
    data = datalow90, weights = w)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-3.9803  -0.6482  -0.6098  -0.5879   9.4271  

Coefficients:
            Estimate Std. Error t value            Pr(>|t|)    
(Intercept) -1.71815    0.09918 -17.324 <0.0000000000000002 ***
truRed24YES -0.27452    0.14655  -1.873              0.0612 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 2.032684)

    Null deviance: 2587.1  on 1603  degrees of freedom
Residual deviance: 2580.0  on 1602  degrees of freedom
AIC: NA

Number of Fisher Scoring iterations: 6

> exp(coef(modelIPTW90))
(Intercept) truRed24YES 
  0.1793984   0.7599397 
> exp(confint(modelIPTW90))
Waiting for profiling to be done...
                2.5 %    97.5 %
(Intercept) 0.1470329 0.2169743
truRed24YES 0.5694222 1.0120380
> exp(cbind(OR = coef(modelIPTW90), confint(modelIPTW90)))
Waiting for profiling to be done...
                   OR     2.5 %    97.5 %
(Intercept) 0.1793984 0.1470329 0.2169743
truRed24YES 0.7599397 0.5694222 1.0120380
> #双重稳健模型与28天死亡风险
> #拟合逆概率加权后输血和28天死亡风险
> ipw_svydesign90 <- svydesign(ids = ~ subject_id, weights = ~ w, data = datalow90)
> modelDB90 <-svyglm(death28~truRed24+age2+BMI2+
+                      ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                      ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,family = quasibinomial,design=ipw_svydesign90)
> summary(modelDB90)

Call:
svyglm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    design = ipw_svydesign90, family = quasibinomial)

Survey design:
svydesign(ids = ~subject_id, weights = ~w, data = datalow90)

Coefficients:
                  Estimate Std. Error t value         Pr(>|t|)    
(Intercept)      1.5666950  7.3320515   0.214         0.830826    
truRed24YES     -0.1877502  0.2873830  -0.653         0.513652    
age2>=80         0.6343763  0.2671871   2.374         0.017703 *  
BMI218.5-25     -1.2867496  0.5661276  -2.273         0.023167 *  
BMI2>25         -1.4787488  0.5447227  -2.715         0.006706 ** 
ph2<=7.30       -0.6038587  0.2650727  -2.278         0.022855 *  
genderM         -0.4735117  0.2555948  -1.853         0.064129 .  
Renal            0.1401786  0.2882951   0.486         0.626870    
CHFYES           0.0567292  0.2545792   0.223         0.823693    
COPDYES          0.0728304  0.2544782   0.286         0.774766    
LiverYES         0.8486137  0.3465244   2.449         0.014437 *  
DiabetesYES     -0.3089398  0.2674744  -1.155         0.248255    
HR2>=100         0.3488363  0.4073498   0.856         0.391931    
MBP2<=65         0.2643659  0.3483574   0.759         0.448030    
RR2              0.4362091  0.2673529   1.632         0.102967    
pt               0.0396446  0.0122899   3.226         0.001282 ** 
ptt              0.0132684  0.0034796   3.813         0.000142 ***
lac>=4           0.0711699  0.2529824   0.281         0.778499    
ventil           0.5910986  0.3025679   1.954         0.050925 .  
SAPSIII>=60      2.0821647  0.2965976   7.020 0.00000000000328 ***
sepsis_shockYES  0.9145262  0.2773649   3.297         0.000998 ***
sofa2>=5        -0.0279173  0.2417843  -0.115         0.908092    
po2             -0.0084000  0.0033667  -2.495         0.012698 *  
pco2             0.0116885  0.0092661   1.261         0.207343    
glucose          0.0034316  0.0025766   1.332         0.183106    
potassium        0.4595501  0.2191273   2.097         0.036136 *  
T_min           -0.2068922  0.1131460  -1.829         0.067657 .  
T_max            0.0130406  0.1825324   0.071         0.943054    
los_icu         -0.0027456  0.0008062  -3.406         0.000677 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 0.8747906)

Number of Fisher Scoring iterations: 6

> exp(coef(modelDB90))
    (Intercept)     truRed24YES        age2>=80     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
      4.7907883       0.8288218       1.8858456       0.2761670       0.2279227       0.5466980       0.6228113 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
      1.1504792       1.0583692       1.0755481       2.3364056       0.7342250       1.4174172       1.3026047 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
      1.5468322       1.0404409       1.0133568       1.0737637       1.8059714       8.0218152       2.4955926 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
      0.9724688       0.9916352       1.0117571       1.0034375       1.5833614       0.8131073       1.0131260 
        los_icu 
      0.9972581 
> exp(confint(modelDB90))
                         2.5 %          97.5 %
(Intercept)     0.000002719904 8438403.9664178
truRed24YES     0.471685129684       1.4563646
age2>=80        1.116609035959       3.1850124
BMI218.5-25     0.090972994410       0.8383609
BMI2>25         0.078300078896       0.6634572
ph2<=7.30       0.325045168254       0.9194990
genderM         0.377247563359       1.0282211
Renal           0.653571094791       2.0251851
CHFYES          0.642350880641       1.7438215
COPDYES         0.652906529435       1.7717753
LiverYES        1.184020731988       4.6103847
DiabetesYES     0.434489629863       1.2407346
HR2>=100        0.637520606350       3.1513828
MBP2<=65        0.657752081149       2.5796634
RR2             0.915581449759       2.6133010
pt              1.015659637547       1.0658269
ptt             1.006464115394       1.0202967
lac>=4          0.653738498214       1.7636539
ventil          0.997623219878       3.2693031
SAPSIII>=60     4.483468897843      14.3526185
sepsis_shockYES 1.448433806699       4.2998048
sofa2>=5        0.605215776329       1.5625759
po2             0.985108204103       0.9982054
pco2            0.993534283899       1.0303141
glucose         0.998378993612       1.0085217
potassium       1.030184701811       2.4335766
T_min           0.651274027261       1.0151540
T_max           0.708226372918       1.4492886
los_icu         0.995682367071       0.9988364
> exp(cbind(OR = coef(modelDB90), confint(modelDB90)))
                       OR          2.5 %          97.5 %
(Intercept)     4.7907883 0.000002719904 8438403.9664178
truRed24YES     0.8288218 0.471685129684       1.4563646
age2>=80        1.8858456 1.116609035959       3.1850124
BMI218.5-25     0.2761670 0.090972994410       0.8383609
BMI2>25         0.2279227 0.078300078896       0.6634572
ph2<=7.30       0.5466980 0.325045168254       0.9194990
genderM         0.6228113 0.377247563359       1.0282211
Renal           1.1504792 0.653571094791       2.0251851
CHFYES          1.0583692 0.642350880641       1.7438215
COPDYES         1.0755481 0.652906529435       1.7717753
LiverYES        2.3364056 1.184020731988       4.6103847
DiabetesYES     0.7342250 0.434489629863       1.2407346
HR2>=100        1.4174172 0.637520606350       3.1513828
MBP2<=65        1.3026047 0.657752081149       2.5796634
RR2             1.5468322 0.915581449759       2.6133010
pt              1.0404409 1.015659637547       1.0658269
ptt             1.0133568 1.006464115394       1.0202967
lac>=4          1.0737637 0.653738498214       1.7636539
ventil          1.8059714 0.997623219878       3.2693031
SAPSIII>=60     8.0218152 4.483468897843      14.3526185
sepsis_shockYES 2.4955926 1.448433806699       4.2998048
sofa2>=5        0.9724688 0.605215776329       1.5625759
po2             0.9916352 0.985108204103       0.9982054
pco2            1.0117571 0.993534283899       1.0303141
glucose         1.0034375 0.998378993612       1.0085217
potassium       1.5833614 1.030184701811       2.4335766
T_min           0.8131073 0.651274027261       1.0151540
T_max           1.0131260 0.708226372918       1.4492886
los_icu         0.9972581 0.995682367071       0.9988364

 ###输血与预后分析
> #10-11g输血与预后关系
> # install.packages("MatchIt")
> # install.packages("tableone")
> ##多因素分析
> datalow11 <- data[(data$low_hb>=10)&(data$low_hb<=11),]
> modellow11 <- glm(death28~truRed24+age2+BMI2+
+                     ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                     ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu, data=datalow11, family='binomial')
> summary(modellow11)

Call:
glm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    family = "binomial", data = datalow11)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.2260  -0.5543  -0.3388  -0.2293   2.6981  

Coefficients:
                  Estimate Std. Error z value        Pr(>|z|)    
(Intercept)      0.7487928  4.7254164   0.158        0.874094    
truRed24YES     -0.0782738  0.4180447  -0.187        0.851474    
age2>=80         0.4672428  0.1784329   2.619        0.008829 ** 
BMI218.5-25     -0.2517978  0.4445890  -0.566        0.571149    
BMI2>25         -0.4494383  0.4405264  -1.020        0.307619    
ph2<=7.30       -0.1728780  0.2063036  -0.838        0.402043    
genderM         -0.2393941  0.1761216  -1.359        0.174066    
Renal            0.0763834  0.2009207   0.380        0.703821    
CHFYES           0.2181078  0.1794768   1.215        0.224274    
COPDYES         -0.0551727  0.1887289  -0.292        0.770028    
LiverYES         0.2381679  0.2793228   0.853        0.393847    
DiabetesYES     -0.3122055  0.1947463  -1.603        0.108904    
HR2>=100         0.0258908  0.2273164   0.114        0.909319    
MBP2<=65         0.0062432  0.3063414   0.020        0.983740    
RR2              0.3353071  0.1874625   1.789        0.073669 .  
pt               0.0187418  0.0071421   2.624        0.008687 ** 
ptt              0.0069724  0.0024557   2.839        0.004521 ** 
lac>=4           0.2484132  0.2235774   1.111        0.266532    
ventil           0.7195761  0.2178776   3.303        0.000958 ***
SAPSIII>=60      1.3106449  0.2001432   6.549 0.0000000000581 ***
sepsis_shockYES  0.9221313  0.2350284   3.923 0.0000872755630 ***
sofa2>=5        -0.2211359  0.1977276  -1.118        0.263402    
po2             -0.0066898  0.0023120  -2.893        0.003810 ** 
pco2            -0.0070702  0.0065953  -1.072        0.283717    
glucose          0.0022935  0.0020969   1.094        0.274069    
potassium        0.3582782  0.1417073   2.528        0.011462 *  
T_min            0.0921216  0.1092782   0.843        0.399228    
T_max           -0.2183248  0.1164021  -1.876        0.060709 .  
los_icu         -0.0007873  0.0006864  -1.147        0.251355    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1219.06  on 1356  degrees of freedom
Residual deviance:  956.26  on 1328  degrees of freedom
AIC: 1014.3

Number of Fisher Scoring iterations: 5

> exp(coef(modellow11))
    (Intercept)     truRed24YES        age2>=80     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
      2.1144458       0.9247112       1.5955888       0.7774019       0.6379864       0.8412403       0.7871046 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
      1.0793764       1.2437212       0.9463217       1.2689223       0.7318311       1.0262289       1.0062628 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
      1.3983698       1.0189185       1.0069967       1.2819896       2.0535624       3.7085647       2.5146441 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
      0.8016078       0.9933326       0.9929548       1.0022961       1.4308636       1.0964981       0.8038643 
        los_icu 
      0.9992130 
> exp(confint(modellow11))
Waiting for profiling to be done...
                       2.5 %        97.5 %
(Intercept)     0.0002033178 23444.0753041
truRed24YES     0.3889530706     2.0248096
age2>=80        1.1241692971     2.2643132
BMI218.5-25     0.3318330530     1.9209151
BMI2>25         0.2748170721     1.5658911
ph2<=7.30       0.5595131476     1.2573690
genderM         0.5572131830     1.1122164
Renal           0.7244783045     1.5940311
CHFYES          0.8732871545     1.7661647
COPDYES         0.6512639438     1.3659645
LiverYES        0.7263720965     2.1755197
DiabetesYES     0.4970808852     1.0676148
HR2>=100        0.6525509071     1.5926377
MBP2<=65        0.5445813989     1.8143187
RR2             0.9678101213     2.0196070
pt              1.0046449066     1.0333084
ptt             1.0020965861     1.0118084
lac>=4          0.8223677148     1.9777913
ventil          1.3468902497     3.1683890
SAPSIII>=60     2.5141636370     5.5158653
sepsis_shockYES 1.5861028451     3.9899790
sofa2>=5        0.5405634513     1.1746574
po2             0.9886611417     0.9976712
pco2            0.9798841688     1.0056118
glucose         0.9981511299     1.0064048
potassium       1.0849485730     1.8920124
T_min           0.8884328512     1.3632035
T_max           0.6376811495     1.0070323
los_icu         0.9978320167     1.0005282
> exp(cbind(OR = coef(modellow11), confint(modellow11)))
Waiting for profiling to be done...
                       OR        2.5 %        97.5 %
(Intercept)     2.1144458 0.0002033178 23444.0753041
truRed24YES     0.9247112 0.3889530706     2.0248096
age2>=80        1.5955888 1.1241692971     2.2643132
BMI218.5-25     0.7774019 0.3318330530     1.9209151
BMI2>25         0.6379864 0.2748170721     1.5658911
ph2<=7.30       0.8412403 0.5595131476     1.2573690
genderM         0.7871046 0.5572131830     1.1122164
Renal           1.0793764 0.7244783045     1.5940311
CHFYES          1.2437212 0.8732871545     1.7661647
COPDYES         0.9463217 0.6512639438     1.3659645
LiverYES        1.2689223 0.7263720965     2.1755197
DiabetesYES     0.7318311 0.4970808852     1.0676148
HR2>=100        1.0262289 0.6525509071     1.5926377
MBP2<=65        1.0062628 0.5445813989     1.8143187
RR2             1.3983698 0.9678101213     2.0196070
pt              1.0189185 1.0046449066     1.0333084
ptt             1.0069967 1.0020965861     1.0118084
lac>=4          1.2819896 0.8223677148     1.9777913
ventil          2.0535624 1.3468902497     3.1683890
SAPSIII>=60     3.7085647 2.5141636370     5.5158653
sepsis_shockYES 2.5146441 1.5861028451     3.9899790
sofa2>=5        0.8016078 0.5405634513     1.1746574
po2             0.9933326 0.9886611417     0.9976712
pco2            0.9929548 0.9798841688     1.0056118
glucose         1.0022961 0.9981511299     1.0064048
potassium       1.4308636 1.0849485730     1.8920124
T_min           1.0964981 0.8884328512     1.3632035
T_max           0.8038643 0.6376811495     1.0070323
los_icu         0.9992130 0.9978320167     1.0005282


> # 倾向性匹配分析
> # install.packages("Matching")
> library(MatchIt)
> library(tableone)
> mlow11 <-matchit(data=datalow11,
+                  formula=truRed24~age2+BMI2+
+                    ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                    ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,
+                  method="nearest",distance = "logit",replace=FALSE,caliper=0.1,ratio = 1)
> summary(mlow11)

Call:
matchit(formula = truRed24 ~ age2 + BMI2 + ph2 + gender + Renal + 
    CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + pt + ptt + 
    lac + ventil + SAPSIII + sepsis_shock + sofa2 + po2 + pco2 + 
    glucose + potassium + T_min + T_max + los_icu, data = datalow11, 
    method = "nearest", distance = "logit", replace = FALSE, 
    caliper = 0.1, ratio = 1)

Summary of Balance for All Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance               0.1292        0.0396          0.7744     3.9169    0.3169   0.4946
age2<80                0.7458        0.6448          0.2318          .    0.1009   0.1009
age2>=80               0.2542        0.3552         -0.2318          .    0.1009   0.1009
BMI2<18.5              0.0508        0.0262          0.1122          .    0.0247   0.0247
BMI218.5-25            0.2712        0.2704          0.0017          .    0.0008   0.0008
BMI2>25                0.6780        0.7034         -0.0544          .    0.0254   0.0254
ph2>7.30               0.4068        0.5917         -0.3764          .    0.1849   0.1849
ph2<=7.30              0.5932        0.4083          0.3764          .    0.1849   0.1849
genderF                0.4576        0.3960          0.1237          .    0.0616   0.0616
genderM                0.5424        0.6040         -0.1237          .    0.0616   0.0616
Renal                  0.1864        0.2134         -0.0692          .    0.0270   0.0270
CHFNO                  0.6949        0.6502          0.0970          .    0.0447   0.0447
CHFYES                 0.3051        0.3498         -0.0970          .    0.0447   0.0447
COPDNO                 0.6102        0.6988         -0.1817          .    0.0886   0.0886
COPDYES                0.3898        0.3012          0.1817          .    0.0886   0.0886
LiverNO                0.8814        0.9230         -0.1287          .    0.0416   0.0416
LiverYES               0.1186        0.0770          0.1287          .    0.0416   0.0416
DiabetesNO             0.6610        0.6618         -0.0016          .    0.0008   0.0008
DiabetesYES            0.3390        0.3382          0.0016          .    0.0008   0.0008
HR2<100                0.7966        0.8606         -0.1589          .    0.0639   0.0639
HR2>=100               0.2034        0.1394          0.1589          .    0.0639   0.0639
MBP2>65                0.9831        0.9260          0.4417          .    0.0570   0.0570
MBP2<=65               0.0169        0.0740         -0.4417          .    0.0570   0.0570
RR2                    0.1695        0.3983         -0.6099          .    0.2288   0.2288
pt                    16.9593       17.5598         -0.1230     0.2430    0.0476   0.1903
ptt                   46.0458       44.2740          0.0585     1.0378    0.0493   0.1695
lac<4                  0.6949        0.8482         -0.3330          .    0.1533   0.1533
lac>=4                 0.3051        0.1518          0.3330          .    0.1533   0.1533
ventil                 0.8644        0.6263          0.6954          .    0.2381   0.2381
SAPSIII<60             0.5085        0.6025         -0.1880          .    0.0940   0.0940
SAPSIII>=60            0.4915        0.3975          0.1880          .    0.0940   0.0940
sepsis_shockNO         0.7966        0.8644         -0.1684          .    0.0678   0.0678
sepsis_shockYES        0.2034        0.1356          0.1684          .    0.0678   0.0678
sofa2<5                0.7288        0.7766         -0.1074          .    0.0478   0.0478
sofa2>=5               0.2712        0.2234          0.1074          .    0.0478   0.0478
po2                   99.5763       95.6602          0.0924     0.8432    0.0275   0.1163
pco2                  50.9492       48.1294          0.2492     0.6297    0.0415   0.1602
glucose              124.4068      121.5586          0.0742     0.9924    0.0233   0.0709
potassium              3.9339        3.9064          0.0539     0.7787    0.0231   0.0932
T_min                 35.6303       36.1630         -0.5083     1.7344    0.1144   0.3151
T_max                 37.5173       37.5099          0.0112     0.7657    0.0263   0.1055
los_icu              198.2203      115.1680          0.4498     2.3825    0.1630   0.2881


Summary of Balance for Matched Data:
                Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.
distance               0.1066        0.1067         -0.0006     0.9975    0.0008   0.0370          0.0060
age2<80                0.7778        0.7037          0.1701          .    0.0741   0.0741          1.1058
age2>=80               0.2222        0.2963         -0.1701          .    0.0741   0.0741          1.1058
BMI2<18.5              0.0370        0.0556         -0.0843          .    0.0185   0.0185          0.4215
BMI218.5-25            0.2593        0.3148         -0.1250          .    0.0556   0.0556          0.8747
BMI2>25                0.7037        0.6296          0.1585          .    0.0741   0.0741          0.9512
ph2>7.30               0.4259        0.4630         -0.0754          .    0.0370   0.0370          1.1309
ph2<=7.30              0.5741        0.5370          0.0754          .    0.0370   0.0370          1.1309
genderF                0.4630        0.4630          0.0000          .    0.0000   0.0000          0.3333
genderM                0.5370        0.5370          0.0000          .    0.0000   0.0000          0.3333
Renal                  0.1852        0.1481          0.0951          .    0.0370   0.0370          0.6657
CHFNO                  0.7037        0.7407         -0.0804          .    0.0370   0.0370          0.8848
CHFYES                 0.2963        0.2593          0.0804          .    0.0370   0.0370          0.8848
COPDNO                 0.6111        0.7407         -0.2658          .    0.1296   0.1296          0.7214
COPDYES                0.3889        0.2593          0.2658          .    0.1296   0.1296          0.7214
LiverNO                0.8704        0.9074         -0.1145          .    0.0370   0.0370          0.4581
LiverYES               0.1296        0.0926          0.1145          .    0.0370   0.0370          0.4581
DiabetesNO             0.6481        0.7037         -0.1174          .    0.0556   0.0556          0.8215
DiabetesYES            0.3519        0.2963          0.1174          .    0.0556   0.0556          0.8215
HR2<100                0.7963        0.8333         -0.0920          .    0.0370   0.0370          0.7361
HR2>=100               0.2037        0.1667          0.0920          .    0.0370   0.0370          0.7361
MBP2>65                0.9815        1.0000         -0.1435          .    0.0185   0.0185          0.1435
MBP2<=65               0.0185        0.0000          0.1435          .    0.0185   0.0185          0.1435
RR2                    0.1852        0.1296          0.1481          .    0.0556   0.0556          0.6417
pt                    17.0056       17.3241         -0.0652     0.1602    0.0590   0.2963          1.2486
ptt                   46.3222       39.7648          0.2164     1.6162    0.0779   0.2037          0.7535
lac<4                  0.7407        0.7593         -0.0402          .    0.0185   0.0185          0.6033
lac>=4                 0.2593        0.2407          0.0402          .    0.0185   0.0185          0.6033
ventil                 0.8519        0.9074         -0.1623          .    0.0556   0.0556          0.4868
SAPSIII<60             0.5370        0.3889          0.2963          .    0.1481   0.1481          0.9631
SAPSIII>=60            0.4630        0.6111         -0.2963          .    0.1481   0.1481          0.9631
sepsis_shockNO         0.8148        0.8704         -0.1380          .    0.0556   0.0556          0.4141
sepsis_shockYES        0.1852        0.1296          0.1380          .    0.0556   0.0556          0.4141
sofa2<5                0.7407        0.6667          0.1666          .    0.0741   0.0741          0.9997
sofa2>=5               0.2593        0.3333         -0.1666          .    0.0741   0.0741          0.9997
po2                  101.1667       93.5926          0.1788     1.2532    0.0357   0.2222          0.9719
pco2                  50.1852       46.8704          0.2930     0.8893    0.0379   0.1852          0.9609
glucose              126.4630      124.5185          0.0507     1.2618    0.0370   0.1296          0.9880
potassium              3.9481        3.8370          0.2177     1.0451    0.0400   0.1852          1.2190
T_min                 35.6381       35.7607         -0.1170     1.0254    0.0304   0.1481          1.0784
T_max                 37.5046       37.5204         -0.0238     0.9743    0.0281   0.1481          1.1216
los_icu              169.6667      192.1667         -0.1219     0.5545    0.0392   0.1481          0.7102

Percent Balance Improvement:
                Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
distance                   99.9       99.8      99.7     92.5
age2<80                    26.6          .      26.6     26.6
age2>=80                   26.6          .      26.6     26.6
BMI2<18.5                  24.9          .      24.9     24.9
BMI218.5-25             -7111.1          .   -7111.1  -7111.1
BMI2>25                  -191.4          .    -191.4   -191.4
ph2>7.30                   80.0          .      80.0     80.0
ph2<=7.30                  80.0          .      80.0     80.0
genderF                   100.0          .     100.0    100.0
genderM                   100.0          .     100.0    100.0
Renal                     -37.4          .     -37.4    -37.4
CHFNO                      17.1          .      17.1     17.1
CHFYES                     17.1          .      17.1     17.1
COPDNO                    -46.3          .     -46.3    -46.3
COPDYES                   -46.3          .     -46.3    -46.3
LiverNO                    11.0          .      11.0     11.0
LiverYES                   11.0          .      11.0     11.0
DiabetesNO              -7111.1          .   -7111.1  -7111.1
DiabetesYES             -7111.1          .   -7111.1  -7111.1
HR2<100                    42.1          .      42.1     42.1
HR2>=100                   42.1          .      42.1     42.1
MBP2>65                    67.5          .      67.5     67.5
MBP2<=65                   67.5          .      67.5     67.5
RR2                        75.7          .      75.7     75.7
pt                         47.0      -29.5     -23.9    -55.7
ptt                      -270.1    -1194.5     -58.2    -20.2
lac<4                      87.9          .      87.9     87.9
lac>=4                     87.9          .      87.9     87.9
ventil                     76.7          .      76.7     76.7
SAPSIII<60                -57.6          .     -57.6    -57.6
SAPSIII>=60               -57.6          .     -57.6    -57.6
sepsis_shockNO             18.1          .      18.1     18.1
sepsis_shockYES            18.1          .      18.1     18.1
sofa2<5                   -55.1          .     -55.1    -55.1
sofa2>=5                  -55.1          .     -55.1    -55.1
po2                       -93.4      -32.3     -29.9    -91.0
pco2                      -17.6       74.6       8.7    -15.6
glucose                    31.7    -2940.9     -58.9    -82.9
potassium                -304.0       82.4     -73.4    -98.7
T_min                      77.0       95.4      73.5     53.0
T_max                    -112.2       90.2      -7.0    -40.4
los_icu                    72.9       32.1      75.9     48.6

Sample Sizes:
          Control Treated
All          1298      59
Matched        54      54
Unmatched    1244       5
Discarded       0       0

> #提取匹配后病例对照
> set.seed(1111)
> mlowdata11 <- match.data(mlow11,group = "all",
+                          distance = "distance",
+                          weights = "weights",
+                          subclass= "subclass",
+                          data = NULL,
+                          include.s.weights = TRUE,
+                          drop.unmatched = TRUE)
> modelmlow11 <- glm(death28~truRed24, data=mlowdata11, family='binomial')
> summary(modelmlow11)

Call:
glm(formula = death28 ~ truRed24, family = "binomial", data = mlowdata11)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.5663  -0.5663  -0.5270  -0.5270   2.0214  

Coefficients:
            Estimate Std. Error z value  Pr(>|z|)    
(Intercept)  -1.9042     0.4051  -4.700 0.0000026 ***
truRed24YES   0.1550     0.5576   0.278     0.781    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 87.035  on 107  degrees of freedom
Residual deviance: 86.958  on 106  degrees of freedom
AIC: 90.958

Number of Fisher Scoring iterations: 4

> exp(coef(modelmlow11))
(Intercept) truRed24YES 
  0.1489362   1.1677019 
> exp(confint(modelmlow11))
Waiting for profiling to be done...
                 2.5 %    97.5 %
(Intercept) 0.06143769 0.3082368
truRed24YES 0.38853546 3.5821205
> exp(cbind(OR = coef(modelmlow11), confint(modelmlow11)))
Waiting for profiling to be done...
                   OR      2.5 %    97.5 %
(Intercept) 0.1489362 0.06143769 0.3082368
truRed24YES 1.1677019 0.38853546 3.5821205

#逆概率加权
> datalow11$wt1 = 1/datalow11$ps  #输血组权重
> datalow11$wt2 = 1/(1-datalow11$ps) #未输血组权重
> #输血组权重为wt1未输血组权重为wt2
> datalow11$w <- ifelse(datalow11$truRed24=="YES",datalow11$wt1,datalow11$wt2)
> #ITPW后的数据做table
> # install.packages("survey")
> library(survey)
> library(tableone)
> dataIPTW11=svydesign(ids=~0,data=datalow11,weights=~w) #提取ITPW后数据
> #2再次构建Table-1模型
> vars=c("age2" ,"BMI2" ,"ph2" ,"gender", "Renal" ,"CHF", "COPD" ,"Liver" ,"Diabetes", 
+        "HR", "MBP2","RR2","pt","ptt","lac"," ventil", "SAPSIII",
+        "sepsis_shock","sofa2","po2","pco2", "glucose","potassium","T_min","T_max","los_icu")
> 
> tab_IPTW11=svyCreateTableOne(vars=vars,strata="truRed24",data=dataIPTW11,test=T)
Warning message:
In ModuleReturnVarsExist(vars, data$variables) :
  The data frame does not have:  ventil  Dropped
> print(tab_IPTW11,showAllLevels=TRUE,smd=TRUE)
                       Stratified by truRed24
                        level   NO               YES              p      test SMD   
  n                              1363.2           1178.3                            
  age2 (%)              <80       888.3 (65.2)     763.8 (64.8)    0.979       0.007
                        >=80      475.0 (34.8)     414.5 (35.2)                     
  BMI2 (%)              <18.5      41.1 ( 3.0)      58.7 ( 5.0)    0.531       0.230
                        18.5-25   365.9 (26.8)     420.0 (35.6)                     
                        >25       956.3 (70.1)     699.7 (59.4)                     
  ph2 (%)               >7.30     794.8 (58.3)     699.5 (59.4)    0.917       0.022
                        <=7.30    568.5 (41.7)     478.8 (40.6)                     
  gender (%)            F         540.4 (39.6)     329.5 (28.0)    0.194       0.249
                        M         822.9 (60.4)     848.8 (72.0)                     
  Renal (mean (SD))                0.21 (0.41)      0.18 (0.39)    0.649       0.080
  CHF (%)               NO        892.2 (65.5)     892.1 (75.7)    0.246       0.227
                        YES       471.0 (34.5)     286.2 (24.3)                     
  COPD (%)              NO        942.3 (69.1)     879.1 (74.6)    0.504       0.122
                        YES       421.0 (30.9)     299.2 (25.4)                     
  Liver (%)             NO       1252.4 (91.9)    1086.9 (92.2)    0.931       0.014
                        YES       110.8 ( 8.1)      91.4 ( 7.8)                     
  Diabetes (%)          NO        903.4 (66.3)     849.0 (72.1)    0.510       0.125
                        YES       459.8 (33.7)     329.3 (27.9)                     
  HR (mean (SD))                  84.63 (14.61)    83.71 (11.71)   0.626       0.070
  MBP2 (%)              >65      1266.3 (92.9)    1154.9 (98.0)    0.168       0.248
                        <=65       97.0 ( 7.1)      23.4 ( 2.0)                     
  RR2 (mean (SD))                  0.39 (0.49)      0.33 (0.47)    0.652       0.125
  pt (mean (SD))                  17.53 (9.83)     16.94 (5.35)    0.531       0.075
  ptt (mean (SD))                 44.32 (29.68)    40.53 (19.02)   0.123       0.152
  lac (%)               <4       1145.5 (84.0)    1004.2 (85.2)    0.832       0.033
                        >=4       217.7 (16.0)     174.0 (14.8)                     
  SAPSIII (%)           <60       815.4 (59.8)     690.9 (58.6)    0.923       0.024
                        >=60      547.8 (40.2)     487.4 (41.4)                     
  sepsis_shock (%)      NO       1172.4 (86.0)    1088.3 (92.4)    0.125       0.206
                        YES       190.9 (14.0)      90.0 ( 7.6)                     
  sofa2 (%)             <5       1057.7 (77.6)     902.2 (76.6)    0.895       0.024
                        >=5       305.6 (22.4)     276.1 (23.4)                     
  po2 (mean (SD))                 95.93 (46.08)    98.32 (45.63)   0.811       0.052
  pco2 (mean (SD))                48.24 (14.31)    47.86 (8.63)    0.776       0.033
  glucose (mean (SD))            121.70 (38.36)   116.21 (34.17)   0.364       0.151
  potassium (mean (SD))            3.91 (0.58)      3.87 (0.56)    0.747       0.072
  T_min (mean (SD))               36.11 (0.97)     35.96 (0.78)    0.236       0.175
  T_max (mean (SD))               37.51 (0.75)     37.60 (0.54)    0.317       0.139
  los_icu (mean (SD))            119.28 (125.45)  138.40 (114.33)  0.336       0.159
> addmargins(table(ExtractSmd(tab_IPTW11)>0.1))

FALSE  TRUE   Sum 
   12    13    25 
   
   #拟合逆概率加权后输血和28天死亡风险
> modelIPTW11 <-glm(death28~truRed24,family = quasibinomial(link = "logit"),data = datalow11,weight=w)
> summary(modelIPTW11)

Call:
glm(formula = death28 ~ truRed24, family = quasibinomial(link = "logit"), 
    data = datalow11, weights = w)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-5.5920  -0.6120  -0.6041  -0.6002  23.3689  

Coefficients:
            Estimate Std. Error t value             Pr(>|t|)    
(Intercept)  -1.6279     0.1001 -16.255 < 0.0000000000000002 ***
truRed24YES   0.6110     0.1349   4.531            0.0000064 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 1.875667)

    Null deviance: 2620.4  on 1356  degrees of freedom
Residual deviance: 2581.3  on 1355  degrees of freedom
AIC: NA

Number of Fisher Scoring iterations: 8

> exp(coef(modelIPTW11))
(Intercept) truRed24YES 
  0.1963372   1.8423350 
> exp(confint(modelIPTW11))
Waiting for profiling to be done...
                2.5 %    97.5 %
(Intercept) 0.1606199 0.2379307
truRed24YES 1.4159189 2.4033352
> exp(cbind(OR = coef(modelIPTW11), confint(modelIPTW11)))
Waiting for profiling to be done...
                   OR     2.5 %    97.5 %
(Intercept) 0.1963372 0.1606199 0.2379307
truRed24YES 1.8423350 1.4159189 2.4033352
> #双重稳健模型与28天死亡风险
> #拟合逆概率加权后输血和28天死亡风险
> ipw_svydesign11 <- svydesign(ids = ~ subject_id, weights = ~ w, data = datalow11)
> modelDB11 <-svyglm(death28~truRed24+age2+BMI2+
+                      ph2+gender+Renal+CHF+COPD+Liver+Diabetes+HR2+MBP2+RR2+pt+
+                      ptt+lac+ventil+SAPSIII+sepsis_shock+sofa2+po2+pco2+glucose+potassium+T_min+T_max+los_icu,family = quasibinomial,design=ipw_svydesign11)
> summary(modelDB11)

Call:
svyglm(formula = death28 ~ truRed24 + age2 + BMI2 + ph2 + gender + 
    Renal + CHF + COPD + Liver + Diabetes + HR2 + MBP2 + RR2 + 
    pt + ptt + lac + ventil + SAPSIII + sepsis_shock + sofa2 + 
    po2 + pco2 + glucose + potassium + T_min + T_max + los_icu, 
    design = ipw_svydesign11, family = quasibinomial)

Survey design:
svydesign(ids = ~subject_id, weights = ~w, data = datalow11)

Coefficients:
                  Estimate Std. Error t value        Pr(>|t|)    
(Intercept)      0.0256336  6.3932440   0.004         0.99680    
truRed24YES      0.8086358  0.3885895   2.081         0.03763 *  
age2>=80         0.7786571  0.2715916   2.867         0.00421 ** 
BMI218.5-25      1.5530309  0.7977083   1.947         0.05176 .  
BMI2>25          0.7737812  0.7907225   0.979         0.32797    
ph2<=7.30       -0.7901706  0.3020881  -2.616         0.00901 ** 
genderM          0.0160856  0.2650117   0.061         0.95161    
Renal           -0.3523139  0.2730537  -1.290         0.19718    
CHFYES           0.0524780  0.2866932   0.183         0.85479    
COPDYES         -0.1770925  0.3003125  -0.590         0.55550    
LiverYES         0.0601541  0.3765789   0.160         0.87311    
DiabetesYES     -0.5211944  0.3095076  -1.684         0.09243 .  
HR2>=100        -0.7872654  0.3718829  -2.117         0.03445 *  
MBP2<=65         0.3053879  0.4307497   0.709         0.47847    
RR2              1.1404535  0.2899123   3.934 0.0000879401733 ***
pt               0.0221167  0.0098475   2.246         0.02487 *  
ptt              0.0059591  0.0038788   1.536         0.12470    
lac>=4           0.6709085  0.3065753   2.188         0.02881 *  
ventil           0.2907203  0.3132217   0.928         0.35349    
SAPSIII>=60      2.4054091  0.3575934   6.727 0.0000000000257 ***
sepsis_shockYES  1.0130686  0.3443047   2.942         0.00331 ** 
sofa2>=5        -0.9051395  0.3092632  -2.927         0.00348 ** 
po2             -0.0067497  0.0028324  -2.383         0.01731 *  
pco2            -0.0097141  0.0087546  -1.110         0.26737    
glucose          0.0014295  0.0029822   0.479         0.63178    
potassium        0.3279928  0.2085476   1.573         0.11602    
T_min           -0.1447909  0.1188297  -1.218         0.22326    
T_max           -0.0077496  0.1736927  -0.045         0.96442    
los_icu         -0.0016486  0.0009496  -1.736         0.08276 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasibinomial family taken to be 1.395804)

Number of Fisher Scoring iterations: 7

> exp(coef(modelDB11))
    (Intercept)     truRed24YES        age2>=80     BMI218.5-25         BMI2>25       ph2<=7.30         genderM 
      1.0259650       2.2448434       2.1785447       4.7257720       2.1679482       0.4537674       1.0162157 
          Renal          CHFYES         COPDYES        LiverYES     DiabetesYES        HR2>=100        MBP2<=65 
      0.7030594       1.0538794       0.8377023       1.0620002       0.5938109       0.4550876       1.3571513 
            RR2              pt             ptt          lac>=4          ventil     SAPSIII>=60 sepsis_shockYES 
      3.1281866       1.0223631       1.0059769       1.9560135       1.3373905      11.0829629       2.7540391 
       sofa2>=5             po2            pco2         glucose       potassium           T_min           T_max 
      0.4044855       0.9932731       0.9903329       1.0014305       1.3881790       0.8652032       0.9922803 
        los_icu 
      0.9983528 
> exp(confint(modelDB11))
                         2.5 %         97.5 %
(Intercept)     0.000003666309 287101.8499057
truRed24YES     1.047409085157      4.8112261
age2>=80        1.278722755095      3.7115607
BMI218.5-25     0.988195336813     22.5997028
BMI2>25         0.459590164712     10.2265009
ph2<=7.30       0.250876982039      0.8207402
genderM         0.604229326868      1.7091100
Renal           0.411487129974      1.2012345
CHFYES          0.600529843079      1.8494697
COPDYES         0.464761362711      1.5099042
LiverYES        0.507326660240      2.2231130
DiabetesYES     0.323559707595      1.0897876
HR2>=100        0.219411270600      0.9439109
MBP2<=65        0.582960312354      3.1594940
RR2             1.771306622283      5.5244820
pt              1.002802215507      1.0423055
ptt             0.998351153504      1.0136608
lac>=4          1.071954657495      3.5691705
ventil          0.723436217672      2.4723856
SAPSIII>=60     5.495334335006     22.3520642
sepsis_shockYES 1.401619156773      5.4114069
sofa2>=5        0.220504486560      0.7419735
po2             0.987769180939      0.9988076
pco2            0.973469873652      1.0074881
glucose         0.995588903009      1.0073063
potassium       0.922077645928      2.0898901
T_min           0.685295412640      1.0923414
T_max           0.705751814303      1.3951367
los_icu         0.996494781181      1.0002142
> exp(cbind(OR = coef(modelDB11), confint(modelDB11)))
                        OR          2.5 %         97.5 %
(Intercept)      1.0259650 0.000003666309 287101.8499057
truRed24YES      2.2448434 1.047409085157      4.8112261
age2>=80         2.1785447 1.278722755095      3.7115607
BMI218.5-25      4.7257720 0.988195336813     22.5997028
BMI2>25          2.1679482 0.459590164712     10.2265009
ph2<=7.30        0.4537674 0.250876982039      0.8207402
genderM          1.0162157 0.604229326868      1.7091100
Renal            0.7030594 0.411487129974      1.2012345
CHFYES           1.0538794 0.600529843079      1.8494697
COPDYES          0.8377023 0.464761362711      1.5099042
LiverYES         1.0620002 0.507326660240      2.2231130
DiabetesYES      0.5938109 0.323559707595      1.0897876
HR2>=100         0.4550876 0.219411270600      0.9439109
MBP2<=65         1.3571513 0.582960312354      3.1594940
RR2              3.1281866 1.771306622283      5.5244820
pt               1.0223631 1.002802215507      1.0423055
ptt              1.0059769 0.998351153504      1.0136608
lac>=4           1.9560135 1.071954657495      3.5691705
ventil           1.3373905 0.723436217672      2.4723856
SAPSIII>=60     11.0829629 5.495334335006     22.3520642
sepsis_shockYES  2.7540391 1.401619156773      5.4114069
sofa2>=5         0.4044855 0.220504486560      0.7419735
po2              0.9932731 0.987769180939      0.9988076
pco2             0.9903329 0.973469873652      1.0074881
glucose          1.0014305 0.995588903009      1.0073063
potassium        1.3881790 0.922077645928      2.0898901
T_min            0.8652032 0.685295412640      1.0923414
T_max            0.9922803 0.705751814303      1.3951367
los_icu          0.9983528 0.996494781181      1.0002142
